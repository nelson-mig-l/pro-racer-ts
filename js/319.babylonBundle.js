"use strict";(self.webpackChunkpro_racer=self.webpackChunkpro_racer||[]).push([[319],{2319:(e,t,n)=>{n.d(t,{ms:()=>s,VW:()=>r,ey:()=>v,B2:()=>f,em:()=>m,zA:()=>p,JM:()=>_});var s={};n.r(s),n.d(s,{EBlendingFunction:()=>O,EComponentType:()=>y,ECullingType:()=>x,EParameterType:()=>b,EShaderType:()=>A,ETextureFilterType:()=>T,ETextureFormat:()=>E,ETextureWrapMode:()=>g,GLTFBinaryExtension:()=>Oe,GLTFLoader:()=>Ee,GLTFLoaderBase:()=>Te,GLTFLoaderExtension:()=>xe,GLTFMaterialsCommonExtension:()=>Me,GLTFUtils:()=>z});var r={};n.r(r),n.d(r,{ArrayItem:()=>ke,EXT_lights_image_based:()=>We,EXT_mesh_gpu_instancing:()=>je,EXT_meshopt_compression:()=>Ze,EXT_texture_webp:()=>ze,ExtrasAsMetadata:()=>un,GLTFLoader:()=>Ve,KHR_animation_pointer:()=>zt,KHR_draco_mesh_compression:()=>tt,KHR_lights:()=>rt,KHR_materials_clearcoat:()=>dt,KHR_materials_emissive_strength:()=>mt,KHR_materials_ior:()=>gt,KHR_materials_iridescence:()=>ut,KHR_materials_pbrSpecularGlossiness:()=>at,KHR_materials_sheen:()=>pt,KHR_materials_specular:()=>At,KHR_materials_translucency:()=>vt,KHR_materials_transmission:()=>wt,KHR_materials_unlit:()=>lt,KHR_materials_variants:()=>Et,KHR_materials_volume:()=>St,KHR_mesh_quantization:()=>Nt,KHR_texture_basisu:()=>It,KHR_texture_transform:()=>$t,KHR_xmp_json_ld:()=>Bt,MSFT_audio_emitter:()=>sn,MSFT_lod:()=>on,MSFT_minecraftMesh:()=>ln,MSFT_sRGBFactors:()=>dn});var o=n(4673),a=n(4651),i=n(2719),l=n(5702),c=n(9288),d=n(2830);function h(e,t,n,s){const r={externalResourceFunction:e=>s(e).then((e=>new Uint8Array(e)))};return n&&(r.uri="file:"===t?n:t+n),e instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(e),r):GLTFValidator.validateString(e,r)}function u(){const e=[];onmessage=t=>{const n=t.data;switch(n.id){case"init":importScripts(n.url);break;case"validate":h(n.data,n.rootUrl,n.fileName,(t=>new Promise(((n,s)=>{const r=e.length;e.push({resolve:n,reject:s}),postMessage({id:"getExternalResource",index:r,uri:t})})))).then((e=>{postMessage({id:"validate.resolve",value:e})}),(e=>{postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[n.index].resolve(n.value);break;case"getExternalResource.reject":e[n.index].reject(n.reason)}}}class _{static ValidateAsync(e,t,n,s){return"function"==typeof Worker?new Promise(((r,o)=>{const a=`${h}(${u})()`,i=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),l=new Worker(i),c=e=>{l.removeEventListener("error",c),l.removeEventListener("message",d),o(e)},d=e=>{const t=e.data;switch(t.id){case"getExternalResource":s(t.uri).then((e=>{l.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e])}),(e=>{l.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})}));break;case"validate.resolve":l.removeEventListener("error",c),l.removeEventListener("message",d),r(t.value),l.terminate();break;case"validate.reject":l.removeEventListener("error",c),l.removeEventListener("message",d),o(t.reason),l.terminate()}};l.addEventListener("error",c),l.addEventListener("message",d),l.postMessage({id:"init",url:this.Configuration.url}),l.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})})):(this._LoadScriptPromise||(this._LoadScriptPromise=a.w1.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((()=>h(e,t,n,s))))}}_.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};var m,f,p,y,A,b,g,T,E,x,O,M=n(4107),w=n(6790);function L(e,t,n){try{return Promise.resolve(new Uint8Array(e,t,n))}catch(e){return Promise.reject(e)}}!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(m||(m={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(f||(f={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(p||(p={}));class v{constructor(){this.onParsedObservable=new o.y$,this.coordinateSystemMode=m.AUTO,this.animationStartMode=f.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new o.y$,this.onSkinLoadedObservable=new o.y$,this.onTextureLoadedObservable=new o.y$,this.onMaterialLoadedObservable=new o.y$,this.onCameraLoadedObservable=new o.y$,this.onCompleteObservable=new o.y$,this.onErrorObservable=new o.y$,this.onDisposeObservable=new o.y$,this.onExtensionLoadedObservable=new o.y$,this.validate=!1,this.onValidatedObservable=new o.y$,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new o.y$,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,s,r,i){this._progressCallback=s;const l=t.name?"file:":a.w1.GetFolderPath(t),h=t.name||a.w1.GetFilename(t);if(r){if(this.useRangeRequests){this.validate&&c.Y.Warn("glTF validation is not supported when range requests are enabled");const s={abort:()=>{},onCompleteObservable:new o.y$},r={readAsync:(n,s)=>new Promise(((r,o)=>{this._loadFile(e,t,(e=>{r(new Uint8Array(e))}),!0,(e=>{o(e)}),(e=>{e.setRequestHeader("Range",`bytes=${n}-${n+s-1}`)}))})),byteLength:0};return this._unpackBinaryAsync(new d.d(r)).then((e=>{s.onCompleteObservable.notifyObservers(s),n(e)}),i?e=>i(void 0,e):void 0),s}return this._loadFile(e,t,(t=>{this._validate(e,t,l,h),this._unpackBinaryAsync(new d.d({readAsync:(e,n)=>L(t,e,n),byteLength:t.byteLength})).then((e=>{n(e)}),i?e=>i(void 0,e):void 0)}),!0,i)}return this._loadFile(e,t,(t=>{this._validate(e,t,l,h),n({json:this._parseJson(t)})}),r,i)}importMeshAsync(e,t,n,s,r,o){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,s,r,o))))}loadAsync(e,t,n,s,r){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,s,r))))}loadAssetContainerAsync(e,t,n,s,r){return Promise.resolve().then((()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const o=new l.TJ(e),a=[];this.onMaterialLoadedObservable.add((e=>{a.push(e)}));const i=[];this.onTextureLoadedObservable.add((e=>{i.push(e)}));const c=[];return this.onCameraLoadedObservable.add((e=>{c.push(e)})),this._loader.importMeshAsync(null,e,o,t,n,s,r).then((e=>(Array.prototype.push.apply(o.geometries,e.geometries),Array.prototype.push.apply(o.meshes,e.meshes),Array.prototype.push.apply(o.particleSystems,e.particleSystems),Array.prototype.push.apply(o.skeletons,e.skeletons),Array.prototype.push.apply(o.animationGroups,e.animationGroups),Array.prototype.push.apply(o.materials,a),Array.prototype.push.apply(o.textures,i),Array.prototype.push.apply(o.lights,e.lights),Array.prototype.push.apply(o.transformNodes,e.transformNodes),Array.prototype.push.apply(o.cameras,c),o)))}))}canDirectLoad(e){return-1!==e.indexOf("asset")&&-1!==e.indexOf("version")||e.startsWith("data:base64,"+v._MagicBase64Encoded)||e.startsWith("data:;base64,"+v._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+v._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+v._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+v._MagicBase64Encoded)||t.startsWith(";base64,"+v._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+v._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+v._MagicBase64Encoded)){const n=(0,M.$K)(t);return this._validate(e,n),this._unpackBinaryAsync(new d.d({readAsync:(e,t)=>L(n,e,t),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new v}get loaderState(){return this._state}whenCompleteAsync(){return new Promise(((e,t)=>{this.onCompleteObservable.addOnce((()=>{e()})),this.onErrorObservable.addOnce((e=>{t(e)}))}))}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(p[this._state]))}_loadFile(e,t,n,s,r,o){const a=e._loadFile(t,n,(e=>{this._onProgress(e,a)}),!0,s,r,o);return a.onCompleteObservable.add((e=>{this._requests.splice(this._requests.indexOf(e),1)})),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,s=0,r=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;n=n&&e._lengthComputable,s+=e._loaded,r+=e._total}this._progressCallback({lengthComputable:n,loaded:s,total:n?r:0})}_validate(e,t,n="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),_.ValidateAsync(t,n,s,(t=>this.preprocessUrlAsync(n+t).then((t=>e._loadFileAsync(t,void 0,!0,!0))))).then((e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()}),(e=>{this._endPerformanceCounter("Validate JSON"),a.w1.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()})))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=v._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=v._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(v._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const s={1:v._CreateGLTF1Loader,2:v._CreateGLTF2Loader}[n.major];if(!s)throw new Error("Unsupported version: "+t.version);return s(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((()=>{const t=e.readUint32();if(1179937895!==t)throw new w.LH("Unexpected magic: "+t,w.SM.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const s=e.readUint32();let r;switch(this.useRangeRequests||s===e.buffer.byteLength||c.Y.Warn(`Length in header does not match actual data length: ${s} != ${e.buffer.byteLength}`),n){case 1:r=this._unpackBinaryV1Async(e,s);break;case 2:r=this._unpackBinaryV2Async(e,s);break;default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),r}))}_unpackBinaryV1Async(e,t){const n=e.readUint32(),s=e.readUint32();if(0!==s)throw new Error(`Unexpected content format: ${s}`);const r=t-e.byteOffset,o={json:this._parseJson(e.readString(n)),bin:null};if(0!==r){const t=e.byteOffset;o.bin={readAsync:(n,s)=>e.buffer.readAsync(t+n,s),byteLength:r}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){const n=1313821514,s=e.readUint32();if(e.readUint32()!==n)throw new Error("First chunk format is not JSON");return e.byteOffset+s===t?e.loadAsync(s).then((()=>({json:this._parseJson(e.readString(s)),bin:null}))):e.loadAsync(s+8).then((()=>{const r={json:this._parseJson(e.readString(s)),bin:null},o=()=>{const s=e.readUint32();switch(e.readUint32()){case n:throw new Error("Unexpected JSON chunk");case 5130562:{const t=e.byteOffset;r.bin={readAsync:(n,s)=>e.buffer.readAsync(t+n,s),byteLength:s},e.skipBytes(s);break}default:e.skipBytes(s)}return e.byteOffset!==t?e.loadAsync(8).then(o):Promise.resolve(r)};return o()}))}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=v._logSpaces.substr(0,2*this._logIndentLevel);c.Y.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){a.w1.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){a.w1.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}v.IncrementalLoading=!0,v.HomogeneousCoordinates=!1,v._MagicBase64Encoded="Z2xURg",v._logSpaces="                                ",i.n&&i.n.RegisterPlugin(new v),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.FLOAT=5126]="FLOAT"}(y||(y={})),function(e){e[e.FRAGMENT=35632]="FRAGMENT",e[e.VERTEX=35633]="VERTEX"}(A||(A={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D"}(b||(b={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(g||(g={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9728]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(T||(T={})),function(e){e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(E||(E={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(x||(x={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(O||(O={}));var C=n(972),S=n(9859),R=n(5593),N=n(156),P=n(3427),I=n(6614),F=n(3742),$=n(3212),D=n(9061),B=n(4428),k=n(3242),V=n(3778),G=n(4684),U=n(4517),H=n(7959),K=n(2254),W=n(8777),Y=n(7257),j=n(3632),q=n(5348),X=n(3789),Z=n(6340),J=n(4085);class z{static SetMatrix(e,t,n,s,r){let o=null;if("MODEL"===n.semantic?o=t.getWorldMatrix():"PROJECTION"===n.semantic?o=e.getProjectionMatrix():"VIEW"===n.semantic?o=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===n.semantic?o=C.y3.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===n.semantic?o=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===n.semantic?o=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===n.semantic?o=t.getWorldMatrix().invert():"VIEWINVERSE"===n.semantic?o=e.getViewMatrix().invert():"PROJECTIONINVERSE"===n.semantic?o=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===n.semantic?o=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===n.semantic?o=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===n.semantic&&(o=C.y3.Transpose(t.getWorldMatrix().invert())),o)switch(n.type){case b.FLOAT_MAT2:r.setMatrix2x2(s,C.y3.GetAsMatrix2x2(o));break;case b.FLOAT_MAT3:r.setMatrix3x3(s,C.y3.GetAsMatrix3x3(o));break;case b.FLOAT_MAT4:r.setMatrix(s,o)}}static SetUniform(e,t,n,s){switch(s){case b.FLOAT:return e.setFloat(t,n),!0;case b.FLOAT_VEC2:return e.setVector2(t,C.FM.FromArray(n)),!0;case b.FLOAT_VEC3:return e.setVector3(t,C.P.FromArray(n)),!0;case b.FLOAT_VEC4:return e.setVector4(t,C.Lt.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case g.CLAMP_TO_EDGE:return G.x.CLAMP_ADDRESSMODE;case g.MIRRORED_REPEAT:return G.x.MIRROR_ADDRESSMODE;case g.REPEAT:default:return G.x.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case T.LINEAR:case T.LINEAR_MIPMAP_NEAREST:case T.LINEAR_MIPMAP_LINEAR:return G.x.TRILINEAR_SAMPLINGMODE;case T.NEAREST:case T.NEAREST_MIPMAP_NEAREST:return G.x.NEAREST_SAMPLINGMODE;default:return G.x.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,s,r){n=t.byteOffset+n;const o=e.loadedBufferViews[t.buffer];if(n+s>o.byteLength)throw new Error("Buffer access is out of range");const a=o.buffer;switch(n+=o.byteOffset,r){case y.BYTE:return new Int8Array(a,n,s);case y.UNSIGNED_BYTE:return new Uint8Array(a,n,s);case y.SHORT:return new Int16Array(a,n,s);case y.UNSIGNED_SHORT:return new Uint16Array(a,n,s);default:return new Float32Array(a,n,s)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],s=t.count*z.GetByteStrideFromType(t);return z.GetBufferFromBufferView(e,n,t.byteOffset,s,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let s=0;s<n;++s)t+=String.fromCharCode(e[s]);return t}static GetDefaultMaterial(e){if(!z._DefaultMaterial){$.Q.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),$.Q.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};z._DefaultMaterial=new V.j("GLTFDefaultMaterial",e,t,n),z._DefaultMaterial.setColor4("u_emission",new S.HE(.5,.5,.5,1))}return z._DefaultMaterial}}z._DefaultMaterial=null;var Q,ee=n(402);!function(e){e[e.IDENTIFIER=1]="IDENTIFIER",e[e.UNKNOWN=2]="UNKNOWN",e[e.END_OF_INPUT=3]="END_OF_INPUT"}(Q||(Q={}));class te{constructor(e){this._pos=0,this.currentToken=Q.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return Q.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Q.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Q.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const ne=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],se=["world","view","projection","worldView","worldViewProjection","mBones"],re=["translation","rotation","scale"],oe=["position","rotationQuaternion","scaling"],ae=(e,t,n)=>{for(const s in e){const r=e[s];n[t][s]=r}},ie=e=>{if(e)for(let t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},le=e=>{if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){const t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},ce=e=>{let t=null;if(e.translation||e.rotation||e.scale){const n=C.P.FromArray(e.scale||[1,1,1]),s=C._f.FromArray(e.rotation||[0,0,0,1]),r=C.P.FromArray(e.translation||[0,0,0]);t=C.y3.Compose(n,s,r)}else t=C.y3.FromArray(e.matrix);return t},de=(e,t,n,s)=>{for(let e=0;e<s.bones.length;e++)if(s.bones[e].name===n)return s.bones[e];const r=e.nodes;for(const o in r){const a=r[o];if(!a.jointName)continue;const i=a.children;for(let r=0;r<i.length;r++){const l=e.nodes[i[r]];if(l.jointName&&l.jointName===n){const n=ce(a),r=new I.N(a.name||"",s,de(e,t,a.jointName,s),n);return r.id=o,r}}}return null},he=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n];for(let e=0;e<s.node.children.length;e++)if(s.node.children[e]===t)return s.bone}return null},ue=(e,t)=>{const n=e.nodes;let s=n[t];if(s)return{node:s,id:t};for(const e in n)if(s=n[e],s.jointName===t)return{node:s,id:e};return null},_e=(e,t)=>{for(let n=0;n<e.jointNames.length;n++)if(e.jointNames[n]===t)return!0;return!1},me=(e,t,n,s,r)=>{if(r||(e.scene._blockEntityCollection=!!e.assetContainer,(r=new j.Kj(t.name||"",e.scene))._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,r.id=s),!t.babylonNode)return r;const o=[];let a=null;const i=new Array,l=new Array,c=new Array,d=new Array;for(let t=0;t<n.length;t++){const s=n[t],r=e.meshes[s];if(r)for(let t=0;t<r.primitives.length;t++){const n=new U.x,s=r.primitives[t];s.mode;const h=s.attributes;let u=null,_=null;for(const t in h)if(u=e.accessors[h[t]],_=z.GetBufferFromAccessor(e,u),"NORMAL"===t)n.normals=new Float32Array(_.length),n.normals.set(_);else if("POSITION"===t){if(v.HomogeneousCoordinates){n.positions=new Float32Array(_.length-_.length/4);for(let e=0;e<_.length;e+=4)n.positions[e]=_[e],n.positions[e+1]=_[e+1],n.positions[e+2]=_[e+2]}else n.positions=new Float32Array(_.length),n.positions.set(_);l.push(n.positions.length)}else if(-1!==t.indexOf("TEXCOORD_")){const e=Number(t.split("_")[1]),s=H.o.UVKind+(0===e?"":e+1),r=new Float32Array(_.length);r.set(_),ie(r),n.set(r,s)}else"JOINT"===t?(n.matricesIndices=new Float32Array(_.length),n.matricesIndices.set(_)):"WEIGHT"===t?(n.matricesWeights=new Float32Array(_.length),n.matricesWeights.set(_)):"COLOR"===t&&(n.colors=new Float32Array(_.length),n.colors.set(_));if(u=e.accessors[s.indices],u)_=z.GetBufferFromAccessor(e,u),n.indices=new Int32Array(_.length),n.indices.set(_),d.push(n.indices.length);else{const e=[];for(let t=0;t<n.positions.length/3;t++)e.push(t);n.indices=new Int32Array(e),d.push(n.indices.length)}a?a.merge(n):a=n;const m=e.scene.getMaterialById(s.material);o.push(null===m?z.GetDefaultMaterial(e.scene):m),i.push(0===i.length?0:i[i.length-1]+l[l.length-2]),c.push(0===c.length?0:c[c.length-1]+d[d.length-2])}}let h;e.scene._blockEntityCollection=!!e.assetContainer,o.length>1?(h=new B.G("multimat"+s,e.scene),h.subMaterials=o):h=new k.K("multimat"+s,e.scene),1===o.length&&(h=o[0]),h._parentContainer=e.assetContainer,r.material||(r.material=h),new K.Z(s,e.scene,a,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];let u=0;for(let t=0;t<n.length;t++){const s=n[t],o=e.meshes[s];if(o)for(let e=0;e<o.primitives.length;e++)o.primitives[e].mode,W.P.AddToMesh(u,i[u],l[u],c[u],d[u],r,r,!0),u++}return r},fe=(e,t,n,s)=>{e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=n),e.scaling&&(e.scaling=s)},pe=(e,t,n)=>{let s=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){const r=e.skins[t.skin],o=me(e,t,t.meshes,n,t.babylonNode);o.skeleton=e.scene.getLastSkeletonById(t.skin),null===o.skeleton&&(o.skeleton=((e,t,n,s)=>{if(s||(s=new F.O(t.name||"","",e.scene)),!t.babylonSkeleton)return s;const r=[],o=[];((e,t,n,s)=>{for(const r in e.nodes){const o=e.nodes[r],a=r;if(!o.jointName||_e(n,o.jointName))continue;const i=ce(o),l=new I.N(o.name||"",t,null,i);l.id=a,s.push({bone:l,node:o,id:a})}for(let e=0;e<s.length;e++){const t=s[e],n=t.node.children;for(let e=0;e<n.length;e++){let r=null;for(let t=0;t<s.length;t++)if(s[t].id===n[e]){r=s[t];break}r&&(r.bone._parent=t.bone,t.bone.children.push(r.bone))}}})(e,s,t,r),s.bones=[];for(let n=0;n<t.jointNames.length;n++){const i=ue(e,t.jointNames[n]);if(!i)continue;const l=i.node;if(!l){a.w1.Warn("Joint named "+t.jointNames[n]+" does not exist");continue}const c=i.id,d=e.scene.getBoneById(c);if(d){s.bones.push(d);continue}let h=!1,u=null;for(let r=0;r<n;r++){const n=ue(e,t.jointNames[r]);if(!n)continue;const o=n.node;if(!o){a.w1.Warn("Joint named "+t.jointNames[r]+" does not exist when looking for parent");continue}const i=o.children;if(i){h=!1;for(let n=0;n<i.length;n++)if(i[n]===c){u=de(e,t,t.jointNames[r],s),h=!0;break}if(h)break}}const _=ce(l);!u&&r.length>0&&(u=he(r,c),u&&-1===o.indexOf(u)&&o.push(u)),new I.N(l.jointName||"",s,u,_).id=c}const i=s.bones;s.bones=[];for(let n=0;n<t.jointNames.length;n++){const r=ue(e,t.jointNames[n]);if(r)for(let e=0;e<i.length;e++)if(i[e].id===r.id){s.bones.push(i[e]);break}}s.prepare();for(let e=0;e<o.length;e++)s.bones.push(o[e]);return s})(e,r,0,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=o.skeleton)),s=o}}else if(t.meshes)s=me(e,t,t.mesh?[t.mesh]:t.meshes,n,t.babylonNode);else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){const n=e.cameras[t.camera];if(n){if(e.scene._blockEntityCollection=!!e.assetContainer,"orthographic"===n.type){const n=new N.c(t.camera,C.P.Zero(),e.scene,!1);n.name=t.name||"",n.mode=R.V.ORTHOGRAPHIC_CAMERA,n.attachControl(),s=n,n._parentContainer=e.assetContainer}else if("perspective"===n.type){const r=n[n.type],o=new N.c(t.camera,C.P.Zero(),e.scene,!1);o.name=t.name||"",o.attachControl(),r.aspectRatio||(r.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(o.maxZ=r.zfar,o.minZ=r.znear),s=o,o._parentContainer=e.assetContainer}e.scene._blockEntityCollection=!1}}}else{const n=e.lights[t.light];if(n)if("ambient"===n.type){const r=n[n.type],o=new q.e(t.light,C.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=S.Wo.FromArray(r.color)),s=o}else if("directional"===n.type){const r=n[n.type],o=new X.O(t.light,C.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=S.Wo.FromArray(r.color)),s=o}else if("point"===n.type){const r=n[n.type],o=new Z.c(t.light,C.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=S.Wo.FromArray(r.color)),s=o}else if("spot"===n.type){const r=n[n.type],o=new J.P(t.light,C.P.Zero(),C.P.Zero(),0,0,e.scene);o.name=t.name||"",r.color&&(o.diffuse=S.Wo.FromArray(r.color)),r.fallOfAngle&&(o.angle=r.fallOfAngle),r.fallOffExponent&&(o.exponent=r.fallOffExponent),s=o}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;if(null===s){e.scene._blockEntityCollection=!!e.assetContainer;const n=new j.Kj(t.name||"",e.scene);n._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,t.babylonNode=n,s=n}}if(null!==s){if(t.matrix&&s instanceof j.Kj)((e,t)=>{if(t.matrix){const n=new C.P(0,0,0),s=new C._f,r=new C.P(0,0,0);C.y3.FromArray(t.matrix).decompose(r,s,n),fe(e,n,s,r)}else t.translation&&t.rotation&&t.scale&&fe(e,C.P.FromArray(t.translation),C._f.FromArray(t.rotation),C.P.FromArray(t.scale));e.computeWorldMatrix(!0)})(s,t);else{const e=t.translation||[0,0,0],n=t.rotation||[0,0,0,1],r=t.scale||[1,1,1];fe(s,C.P.FromArray(e),C._f.FromArray(n),C.P.FromArray(r))}s.updateCache(!0),t.babylonNode=s}return s},ye=(e,t,n,s=!1)=>{const r=e.nodes[t];let o=null;if(s=!(e.importOnlyMeshes&&!s&&e.importMeshesNames)||-1!==e.importMeshesNames.indexOf(r.name||"")||0===e.importMeshesNames.length,!r.jointName&&s&&(o=pe(e,r,t),null!==o&&(o.id=t,o.parent=n)),r.children)for(let t=0;t<r.children.length;t++)ye(e,r.children[t],o,s)},Ae=e=>{let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)ye(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let n=0;n<t.nodes.length;n++)ye(e,t.nodes[n],null)}(e=>{for(const t in e.animations){const n=e.animations[t];if(!n.channels||!n.samplers)continue;let s=null;for(let r=0;r<n.channels.length;r++){const o=n.channels[r],i=n.samplers[o.sampler];if(!i)continue;let l=null,c=null;n.parameters?(l=n.parameters[i.input],c=n.parameters[i.output]):(l=i.input,c=i.output);const d=z.GetBufferFromAccessor(e,e.accessors[l]),h=z.GetBufferFromAccessor(e,e.accessors[c]),u=o.target.id;let _=e.scene.getNodeById(u);if(null===_&&(_=e.scene.getNodeByName(u)),null===_){a.w1.Warn("Creating animation named "+t+". But cannot find node named "+u+" to attach to");continue}const m=_ instanceof I.N;let f=o.target.path;const p=re.indexOf(f);-1!==p&&(f=oe[p]);let y=P.f.ANIMATIONTYPE_MATRIX;m||("rotationQuaternion"===f?(y=P.f.ANIMATIONTYPE_QUATERNION,_.rotationQuaternion=new C._f):y=P.f.ANIMATIONTYPE_VECTOR3);let A=null;const b=[];let g=0,T=!1;m&&s&&s.getKeys().length===d.length&&(A=s,T=!0),T||(e.scene._blockEntityCollection=!!e.assetContainer,A=new P.f(t,m?"_matrix":f,1,y,P.f.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(let e=0;e<d.length;e++){let t=null;if("rotationQuaternion"===f?(t=C._f.FromArray([h[g],h[g+1],h[g+2],h[g+3]]),g+=4):(t=C.P.FromArray([h[g],h[g+1],h[g+2]]),g+=3),m){const n=_;let r=C.P.Zero(),o=new C._f,a=C.P.Zero(),i=n.getBaseMatrix();T&&s&&(i=s.getKeys()[e].value),i.decompose(a,o,r),"position"===f?r=t:"rotationQuaternion"===f?o=t:a=t,t=C.y3.Compose(a,o,r)}T?s&&(s.getKeys()[e].value=t):b.push({frame:d[e],value:t})}!T&&A&&(A.setKeys(b),_.animations.push(A)),s=A,e.scene.stopAnimation(_),e.scene.beginAnimation(_,0,d[d.length-1],!0,1)}}})(e);for(let t=0;t<e.scene.skeletons.length;t++){const n=e.scene.skeletons[t];e.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},be=(e,t,n)=>{for(const s in t.uniforms){const r=t.uniforms[s],o=t.parameters[r];if(e.currentIdentifier===s&&o.semantic&&!o.source&&!o.node){const e=ne.indexOf(o.semantic);if(-1!==e)return delete n[s],se[e]}}return e.currentIdentifier},ge=e=>{for(const t in e.materials)xe.LoadMaterialAsync(e,t,(()=>{}),(()=>{}))};class Te{static CreateRuntime(e,t,n){const s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&ae(e.extensions,"extensions",s),e.extensionsUsed&&ae(e.extensionsUsed,"extensionsUsed",s),e.buffers&&((e,t)=>{for(const n in e){const s=e[n];t.buffers[n]=s,t.buffersCount++}})(e.buffers,s),e.bufferViews&&ae(e.bufferViews,"bufferViews",s),e.accessors&&ae(e.accessors,"accessors",s),e.meshes&&ae(e.meshes,"meshes",s),e.lights&&ae(e.lights,"lights",s),e.cameras&&ae(e.cameras,"cameras",s),e.nodes&&ae(e.nodes,"nodes",s),e.images&&ae(e.images,"images",s),e.textures&&ae(e.textures,"textures",s),e.shaders&&((e,t)=>{for(const n in e){const s=e[n];t.shaders[n]=s,t.shaderscount++}})(e.shaders,s),e.programs&&ae(e.programs,"programs",s),e.samplers&&ae(e.samplers,"samplers",s),e.techniques&&ae(e.techniques,"techniques",s),e.materials&&ae(e.materials,"materials",s),e.animations&&ae(e.animations,"animations",s),e.skins&&ae(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s}static LoadBufferAsync(e,t,n,s,r){const o=e.buffers[t];a.w1.IsBase64(o.uri)?setTimeout((()=>n(new Uint8Array(a.w1.DecodeBase64(o.uri))))):a.w1.LoadFile(e.rootUrl+o.uri,(e=>n(new Uint8Array(e))),r,void 0,!0,(e=>{e&&s(e.status+" "+e.statusText)}))}static LoadTextureBufferAsync(e,t,n,s){const r=e.textures[t];if(!r||!r.source)return void s("");if(r.babylonTexture)return void n(null);const o=e.images[r.source];a.w1.IsBase64(o.uri)?setTimeout((()=>n(new Uint8Array(a.w1.DecodeBase64(o.uri))))):a.w1.LoadFile(e.rootUrl+o.uri,(e=>n(new Uint8Array(e))),void 0,void 0,!0,(e=>{e&&s(e.status+" "+e.statusText)}))}static CreateTextureAsync(e,t,n,s){const r=e.textures[t];if(r.babylonTexture)return void s(r.babylonTexture);const o=e.samplers[r.sampler],a=o.minFilter===T.NEAREST_MIPMAP_NEAREST||o.minFilter===T.NEAREST_MIPMAP_LINEAR||o.minFilter===T.LINEAR_MIPMAP_NEAREST||o.minFilter===T.LINEAR_MIPMAP_LINEAR,i=G.x.BILINEAR_SAMPLINGMODE,l=null==n?new Blob:new Blob([n]),c=URL.createObjectURL(l),d=()=>URL.revokeObjectURL(c),h=new G.x(c,e.scene,!a,!0,i,d,d);void 0!==o.wrapS&&(h.wrapU=z.GetWrapMode(o.wrapS)),void 0!==o.wrapT&&(h.wrapV=z.GetWrapMode(o.wrapT)),h.name=t,r.babylonTexture=h,s(h)}static LoadShaderStringAsync(e,t,n,s){const r=e.shaders[t];if(a.w1.IsBase64(r.uri)){const e=atob(r.uri.split(",")[1]);n&&n(e)}else a.w1.LoadFile(e.rootUrl+r.uri,n,void 0,void 0,!1,(e=>{e&&s&&s(e.status+" "+e.statusText)}))}static LoadMaterialAsync(e,t,n,s){const r=e.materials[t];if(!r.technique)return void(s&&s("No technique found."));const o=e.techniques[r.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;const s=new k.K(t,e.scene);return s._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,s.diffuseColor=new S.Wo(.5,.5,.5),s.sideOrientation=D.F.CounterClockWiseSideOrientation,void n(s)}const a=e.programs[o.program],i=o.states,l=$.Q.ShadersStore[a.vertexShader+"VertexShader"],c=$.Q.ShadersStore[a.fragmentShader+"PixelShader"];let d="",h="";const u=new te(l),_=new te(c),m={},f=[],p=[],y=[];for(const e in o.uniforms){const t=o.uniforms[e],n=o.parameters[t];if(m[e]=n,!n.semantic||n.node||n.source)n.type===b.SAMPLER_2D?y.push(e):f.push(e);else{const t=ne.indexOf(n.semantic);-1!==t?(f.push(se[t]),delete m[e]):f.push(e)}}for(const e in o.attributes){const t=o.attributes[e],n=o.parameters[t];if(n.semantic){const e=le(n);e&&p.push(e)}}for(;!u.isEnd()&&u.getNextToken();){if(u.currentToken!==Q.IDENTIFIER){d+=u.currentString;continue}let e=!1;for(const t in o.attributes){const n=o.attributes[t],s=o.parameters[n];if(u.currentIdentifier===t&&s.semantic){d+=le(s),e=!0;break}}e||(d+=be(u,o,m))}for(;!_.isEnd()&&_.getNextToken();)_.currentToken===Q.IDENTIFIER?h+=be(_,o,m):h+=_.currentString;const A={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},g={attributes:p,uniforms:f,samplers:y,needAlphaBlending:i&&i.enable&&-1!==i.enable.indexOf(3042)};$.Q.ShadersStore[a.vertexShader+t+"VertexShader"]=d,$.Q.ShadersStore[a.fragmentShader+t+"PixelShader"]=h;const T=new V.j(t,e.scene,A,g);if(T.onError=((e,t,n)=>(s,r)=>{t.dispose(!0),n("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")})(a,T,s),T.onCompiled=((e,t,n,s,r,o)=>a=>{((e,t,n,s,r)=>{const o=s.values||n.parameters,a=n.uniforms;for(const n in r){const i=r[n],l=i.type;let c=o[a[n]];if(void 0===c&&(c=i.value),!c)continue;const d=e=>n=>{i.value&&e&&(t.setTexture(e,n),delete r[e])};l===b.SAMPLER_2D?xe.LoadTextureAsync(e,s.values?c:i.value,d(n),(()=>d(null))):i.value&&z.SetUniform(t,n,s.values?c:i.value,l)&&delete r[n]}})(e,t,n,s,r),t.onBind=a=>{((e,t,n,s,r,o,a)=>{const i=o.values||r.parameters;for(const a in n){const l=n[a],c=l.type;if(c===b.FLOAT_MAT2||c===b.FLOAT_MAT3||c===b.FLOAT_MAT4)if(!l.semantic||l.source||l.node){if(l.semantic&&(l.source||l.node)){let e=t.scene.getNodeByName(l.source||l.node||"");if(null===e&&(e=t.scene.getNodeById(l.source||l.node||"")),null===e)continue;z.SetMatrix(t.scene,e,l,a,s.getEffect())}}else z.SetMatrix(t.scene,e,l,a,s.getEffect());else{const e=i[r.uniforms[a]];if(!e)continue;if(c===b.SAMPLER_2D){const n=t.textures[o.values?e:l.value].babylonTexture;if(null==n)continue;s.getEffect().setTexture(a,n)}else z.SetUniform(s.getEffect(),a,e,c)}}a(s)})(a,e,r,t,n,s,o)}})(e,T,o,r,m,n),T.sideOrientation=D.F.CounterClockWiseSideOrientation,i&&i.functions){const e=i.functions;e.cullFace&&e.cullFace[0]!==x.BACK&&(T.backFaceCulling=!1);const t=e.blendFuncSeparate;t&&(t[0]===O.SRC_ALPHA&&t[1]===O.ONE_MINUS_SRC_ALPHA&&t[2]===O.ONE&&t[3]===O.ONE?T.alphaMode=ee.g.ALPHA_COMBINE:t[0]===O.ONE&&t[1]===O.ONE&&t[2]===O.ZERO&&t[3]===O.ONE?T.alphaMode=ee.g.ALPHA_ONEONE:t[0]===O.SRC_ALPHA&&t[1]===O.ONE&&t[2]===O.ZERO&&t[3]===O.ONE?T.alphaMode=ee.g.ALPHA_ADD:t[0]===O.ZERO&&t[1]===O.ONE_MINUS_SRC_COLOR&&t[2]===O.ONE&&t[3]===O.ONE?T.alphaMode=ee.g.ALPHA_SUBTRACT:t[0]===O.DST_COLOR&&t[1]===O.ZERO&&t[2]===O.ONE&&t[3]===O.ONE?T.alphaMode=ee.g.ALPHA_MULTIPLY:t[0]===O.SRC_ALPHA&&t[1]===O.ONE_MINUS_SRC_COLOR&&t[2]===O.ONE&&t[3]===O.ONE&&(T.alphaMode=ee.g.ALPHA_MAXIMIZED))}}}class Ee{static RegisterExtension(e){Ee.Extensions[e.name]?a.w1.Error('Tool with the same name "'+e.name+'" already exists'):Ee.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,s,r,o,i,l){return t.useRightHandedSystem=!0,xe.LoadRuntimeAsync(t,n,s,(t=>{t.assetContainer=r,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"==typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],a.w1.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],this._createNodes(t);const n=new Array,s=new Array;for(const e in t.nodes){const s=t.nodes[e];s.babylonNode instanceof Y.x&&n.push(s.babylonNode)}for(const e in t.skins){const n=t.skins[e];n.babylonSkeleton instanceof F.O&&s.push(n.babylonSkeleton)}this._loadBuffersAsync(t,(()=>{this._loadShadersAsync(t,(()=>{ge(t),Ae(t),!v.IncrementalLoading&&o&&o(n,s)}))})),v.IncrementalLoading&&o&&o(n,s)}),l),!0}importMeshAsync(e,t,n,s,r,o){return new Promise(((a,i)=>{this._importMeshAsync(e,t,s,r,n,((e,t)=>{a({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[],geometries:[]})}),o,(e=>{i(new Error(e))}))}))}_loadAsync(e,t,n,s,r,o){e.useRightHandedSystem=!0,xe.LoadRuntimeAsync(e,t,n,(e=>{xe.LoadRuntimeExtensionsAsync(e,(()=>{this._createNodes(e),this._loadBuffersAsync(e,(()=>{this._loadShadersAsync(e,(()=>{ge(e),Ae(e),v.IncrementalLoading||s()}))})),v.IncrementalLoading&&s()}),o)}),o)}loadAsync(e,t,n,s){return new Promise(((r,o)=>{this._loadAsync(e,t,n,(()=>{r()}),s,(e=>{o(new Error(e))}))}))}_loadShadersAsync(e,t){let n=!1;const s=(n,s)=>{xe.LoadShaderStringAsync(e,n,(r=>{r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&($.Q.ShadersStore[n+(s.type===A.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&t())}),(()=>{a.w1.Error("Error when loading shader program named "+n+" located at "+s.uri)}))};for(const t in e.shaders){n=!0;const r=e.shaders[t];r?s.bind(this,t,r)():a.w1.Error("No shader named: "+t)}n||t()}_loadBuffersAsync(e,t){let n=!1;const s=(n,s)=>{xe.LoadBufferAsync(e,n,(r=>{e.loadedBufferCount++,r&&(r.byteLength!=e.buffers[n].byteLength&&a.w1.Error("Buffer named "+n+" is length "+r.byteLength+". Expected: "+s.byteLength),e.loadedBufferViews[n]=r),e.loadedBufferCount===e.buffersCount&&t()}),(()=>{a.w1.Error("Error when loading buffer named "+n+" located at "+s.uri)}))};for(const t in e.buffers){n=!0;const r=e.buffers[t];r?s.bind(this,t,r)():a.w1.Error("No buffer named: "+t)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)ye(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let n=0;n<t.nodes.length;n++)ye(e,t.nodes[n],null)}}}Ee.Extensions={};class xe{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,s,r){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,s,r){return!1}loadTextureBufferAsync(e,t,n,s){return!1}createTextureAsync(e,t,n,s,r){return!1}loadShaderStringAsync(e,t,n,s){return!1}loadMaterialAsync(e,t,n,s){return!1}static LoadRuntimeAsync(e,t,n,s,r){xe._ApplyExtensions((o=>o.loadRuntimeAsync(e,t,n,s,r)),(()=>{setTimeout((()=>{s&&s(Te.CreateRuntime(t.json,e,n))}))}))}static LoadRuntimeExtensionsAsync(e,t,n){xe._ApplyExtensions((s=>s.loadRuntimeExtensionsAsync(e,t,n)),(()=>{setTimeout((()=>{t()}))}))}static LoadBufferAsync(e,t,n,s,r){xe._ApplyExtensions((o=>o.loadBufferAsync(e,t,n,s,r)),(()=>{Te.LoadBufferAsync(e,t,n,s,r)}))}static LoadTextureAsync(e,t,n,s){xe._LoadTextureBufferAsync(e,t,(r=>{r&&xe._CreateTextureAsync(e,t,r,n,s)}),s)}static LoadShaderStringAsync(e,t,n,s){xe._ApplyExtensions((r=>r.loadShaderStringAsync(e,t,n,s)),(()=>{Te.LoadShaderStringAsync(e,t,n,s)}))}static LoadMaterialAsync(e,t,n,s){xe._ApplyExtensions((r=>r.loadMaterialAsync(e,t,n,s)),(()=>{Te.LoadMaterialAsync(e,t,n,s)}))}static _LoadTextureBufferAsync(e,t,n,s){xe._ApplyExtensions((r=>r.loadTextureBufferAsync(e,t,n,s)),(()=>{Te.LoadTextureBufferAsync(e,t,n,s)}))}static _CreateTextureAsync(e,t,n,s,r){xe._ApplyExtensions((o=>o.createTextureAsync(e,t,n,s,r)),(()=>{Te.CreateTextureAsync(e,t,n,s)}))}static _ApplyExtensions(e,t){for(const t in Ee.Extensions)if(e(Ee.Extensions[t]))return;t()}}v._CreateGLTF1Loader=()=>new Ee;class Oe extends xe{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,s){const r=t.json.extensionsUsed;return!(!r||-1===r.indexOf(this.name)||!t.bin||(this._bin=t.bin,s(Te.CreateRuntime(t.json,e,n)),0))}loadBufferAsync(e,t,n,s){return-1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(n,(e=>s(e.message))),!0)}loadTextureBufferAsync(e,t,n){const s=e.textures[t],r=e.images[s.source];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],a=e.bufferViews[o.bufferView];return n(z.GetBufferFromBufferView(e,a,0,a.byteLength,y.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,n){const s=e.shaders[t];if(!s.extensions||!(this.name in s.extensions))return!1;const r=s.extensions[this.name],o=e.bufferViews[r.bufferView],a=z.GetBufferFromBufferView(e,o,0,o.byteLength,y.UNSIGNED_BYTE);return setTimeout((()=>{const e=z.DecodeBufferToText(a);n(e)})),!0}}Ee.RegisterExtension(new Oe);class Me extends xe{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const t in n){const s=n[t];switch(s.type){case"ambient":{const t=new q.e(s.name,new C.P(0,1,0),e.scene),n=s.ambient;n&&(t.diffuse=S.Wo.FromArray(n.color||[1,1,1]));break}case"point":{const t=new Z.c(s.name,new C.P(10,10,10),e.scene),n=s.point;n&&(t.diffuse=S.Wo.FromArray(n.color||[1,1,1]));break}case"directional":{const t=new X.O(s.name,new C.P(0,-1,0),e.scene),n=s.directional;n&&(t.diffuse=S.Wo.FromArray(n.color||[1,1,1]));break}case"spot":{const t=s.spot;t&&(new J.P(s.name,new C.P(0,10,0),new C.P(0,-1,0),t.fallOffAngle||Math.PI,t.fallOffExponent||0,e.scene).diffuse=S.Wo.FromArray(t.color||[1,1,1]));break}default:a.w1.Warn('GLTF Material Common extension: light type "'+s.type+"â€ not supported")}}return!1}loadMaterialAsync(e,t,n,s){const r=e.materials[t];if(!r||!r.extensions)return!1;const o=r.extensions[this.name];if(!o)return!1;const a=new k.K(t,e.scene);return a.sideOrientation=D.F.CounterClockWiseSideOrientation,"CONSTANT"===o.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==o.doubleSided&&!o.doubleSided,a.alpha=void 0===o.values.transparency?1:o.values.transparency,a.specularPower=void 0===o.values.shininess?0:o.values.shininess,"string"==typeof o.values.ambient?this._loadTexture(e,o.values.ambient,a,"ambientTexture",s):a.ambientColor=S.Wo.FromArray(o.values.ambient||[0,0,0]),"string"==typeof o.values.diffuse?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",s):a.diffuseColor=S.Wo.FromArray(o.values.diffuse||[0,0,0]),"string"==typeof o.values.emission?this._loadTexture(e,o.values.emission,a,"emissiveTexture",s):a.emissiveColor=S.Wo.FromArray(o.values.emission||[0,0,0]),"string"==typeof o.values.specular?this._loadTexture(e,o.values.specular,a,"specularTexture",s):a.specularColor=S.Wo.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,s,r){Te.LoadTextureBufferAsync(e,t,(r=>{Te.CreateTextureAsync(e,t,r,(e=>n[s]=e))}),r)}}Ee.RegisterExtension(new Me);var we=n(5414),Le=n(4629),ve=n(5726),Ce=n(8331),Se=n(4482),Re=n(2590),Ne=n(4150),Pe=n(9251);function Ie(e,t,n,s){return C.P.FromArray(t,n).scaleInPlace(s)}class Fe{constructor(e,t,n,s){this.type=e,this.name=t,this.getValue=n,this.getStride=s}_buildAnimation(e,t,n){const s=new P.f(e,this.name,t,this.type);return s.setKeys(n),s}}class $e extends Fe{buildAnimations(e,t,n,s,r){r(e._babylonTransformNode,this._buildAnimation(t,n,s))}}const De={translation:[new $e(P.f.ANIMATIONTYPE_VECTOR3,"position",Ie,(()=>3))],rotation:[new $e(P.f.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",(function(e,t,n,s){return C._f.FromArray(t,n).scaleInPlace(s)}),(()=>4))],scale:[new $e(P.f.ANIMATIONTYPE_VECTOR3,"scaling",Ie,(()=>3))],weights:[new class extends Fe{buildAnimations(e,t,n,s,r){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){const a=new P.f(`${t}_${o}`,this.name,n,this.type);if(a.setKeys(s.map((e=>({frame:e.frame,inTangent:e.inTangent?e.inTangent[o]:void 0,value:e.value[o],outTangent:e.outTangent?e.outTangent[o]:void 0,interpolation:e.interpolation})))),e._primitiveBabylonMeshes)for(const t of e._primitiveBabylonMeshes)if(t.morphTargetManager){const e=t.morphTargetManager.getTarget(o),n=a.clone();e.animations.push(n),r(e,n)}}}}(P.f.ANIMATIONTYPE_FLOAT,"influence",(function(e,t,n,s){const r=new Array(e._numMorphTargets);for(let e=0;e<r.length;e++)r[e]=t[n++]*s;return r}),(e=>e._numMorphTargets))]};function Be(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,n)=>(Object.keys(n).forEach((s=>{const r=e[s],o=n[s];Array.isArray(r)&&Array.isArray(o)?e[s]=r.concat(...o):t(r)&&t(o)?e[s]=Be(r,o):e[s]=o})),e)),{})}class ke{static Get(e,t,n){if(!t||null==n||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class Ve{constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}static RegisterExtension(e,t){Ve.UnregisterExtension(e)&&c.Y.Warn(`Extension with the name '${e}' already exists`),Ve._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return!!Ve._RegisteredExtensions[e]&&(delete Ve._RegisteredExtensions[e],!0)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach((e=>e.dispose&&e.dispose())),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,n,s,r,o,a=""){return Promise.resolve().then((()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(s);let o=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);o=(e instanceof Array?e:[e]).map((e=>{const n=t[e];if(void 0===n)throw new Error(`Failed to find node '${e}'`);return n}))}return this._loadAsync(r,a,o,(()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()})))}))}loadAsync(e,t,n,s,r=""){return Promise.resolve().then((()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(n,r,null,(()=>{})))))}_loadAsync(e,t,n,s){return Promise.resolve().then((()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._loadExtensions(),this._checkExtensions();const r=`${p[p.LOADING]} => ${p[p.READY]}`,o=`${p[p.LOADING]} => ${p[p.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(o),this._parent._setState(p.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(n)i.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=ke.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],n="/materials/"+e,s=D.F.TriangleFillMode;i.push(this._loadMaterialAsync(n,t,null,s,(()=>{})))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync()),Promise.all(i).then((()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(p.READY),this._startAnimations(),s()))).then((e=>(this._parent._endPerformanceCounter(r),a.w1.SetImmediate((()=>{this._disposed||Promise.all(this._completePromises).then((()=>{this._parent._endPerformanceCounter(o),this._parent._setState(p.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()}),(e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()}))})),e)))})).catch((e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e}))}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&c.Y.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else c.Y.Warn("Unexpected BIN chunk")}}_setupData(){if(ke.Assign(this._gltf.accessors),ke.Assign(this._gltf.animations),ke.Assign(this._gltf.buffers),ke.Assign(this._gltf.bufferViews),ke.Assign(this._gltf.cameras),ke.Assign(this._gltf.images),ke.Assign(this._gltf.materials),ke.Assign(this._gltf.meshes),ke.Assign(this._gltf.nodes),ke.Assign(this._gltf.samplers),ke.Assign(this._gltf.scenes),ke.Assign(this._gltf.skins),ke.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const n of t.children)e[n]=t.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const s=e[n.index];n.parent=void 0===s?t:this._gltf.nodes[s]}}}_loadExtensions(){for(const e in Ve._RegisteredExtensions){const t=Ve._RegisteredExtensions[e].factory(this);t.name!==e&&c.Y.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired)if(!this._extensions.some((t=>t.name===e&&t.enabled)))throw new Error(`Require extension ${e} is not available`)}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new j.Kj("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case m.AUTO:this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],Ve._LoadTransform(e,this._rootBabylonMesh));break;case m.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const s=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const n of t.nodes){const t=ke.Get(`${e}/nodes/${n}`,this._gltf.nodes,n);s.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=this._rootBabylonMesh})))}for(const e of this._postSceneLoadActions)e();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then((()=>{}))}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=new Array,t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,(t=>{const n=t.geometry;n&&-1===e.indexOf(n)&&e.push(n)}));return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,(t=>{e.push(t)}));return e}_getTransformNodes(){const e=new Array,t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&"TransformNode"===n._babylonTransformNode.getClassName()&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case f.NONE:break;case f.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case f.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void c.Y.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,n=(()=>{})){const s=this._extensionsLoadNodeAsync(e,t,n);if(s)return s;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const o=s=>{if(Ve.AddPointerMetadata(s,e),Ve._LoadTransform(t,s),null!=t.camera){const n=ke.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${n.index}`,n,(e=>{e.parent=s})))}if(t.children)for(const n of t.children){const t=ke.Get(`${e}/children/${n}`,this._gltf.nodes,n);r.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=s})))}n(s)};if(null==t.mesh||null!=t.skin){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Se.Y(e,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=n:t._babylonTransformNodeForSkin=n,o(n)}if(null!=t.mesh)if(null==t.skin){const n=ke.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${n.index}`,t,n,o))}else{const n=ke.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${n.index}`,t,n,(n=>{const s=t._babylonTransformNodeForSkin;n.metadata=Be(s.metadata,n.metadata||{});const o=ke.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${o.index}`,t,o,(e=>{this._forEachPrimitive(t,(t=>{t.skeleton=e})),this._postSceneLoadActions.push((()=>{if(null!=o.skeleton){const e=ke.Get(`/skins/${o.index}/skeleton`,this._gltf.nodes,o.skeleton).parent;t.index===e.index?n.parent=s.parent:n.parent=e._babylonTransformNode}else n.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:s,skinnedNode:n})}))})))})))}return this.logClose(),Promise.all(r).then((()=>(this._forEachPrimitive(t,(e=>{e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0)})),t._babylonTransformNode)))}_loadMeshAsync(e,t,n,s){const r=n.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);null==r[0].index&&ke.Assign(r);const o=new Array;this.logOpen(`${e} ${n.name||""}`);const a=t.name||`node${t.index}`;if(1===r.length){const s=n.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,a,t,n,s,(e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]})))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Se.Y(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const s of r)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,`${a}_primitive${s.index}`,t,n,s,(e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)})))}return s(t._babylonTransformNode),this.logClose(),Promise.all(o).then((()=>t._babylonTransformNode))}_loadMeshPrimitiveAsync(e,t,n,s,r,o){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,n,s,r,o);if(a)return a;this.logOpen(`${e}`);const i=0===this._disableInstancedMesh&&this._parent.createInstances&&null==n.skin&&!s.primitives[0].targets;let l,c;if(i&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=r._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c=r._instanceData.promise;else{const o=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new j.Kj(t,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?D.F.CounterClockWiseSideOrientation:D.F.ClockWiseSideOrientation,this._createMorphTargets(e,n,s,r,a),o.push(this._loadVertexDataAsync(e,r,a).then((t=>this._loadMorphTargetsAsync(e,r,a,t).then((()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(a),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})))));const d=Ve._GetDrawMode(e,r.mode);if(null==r.material){let e=this._defaultBabylonMaterialData[d];e||(e=this._createDefaultMaterial("__GLTFLoader._default",d),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[d]=e),a.material=e}else if(!this.parent.skipMaterials){const t=ke.Get(`${e}/material`,this._gltf.materials,r.material);o.push(this._loadMaterialAsync(`/materials/${t.index}`,t,a,d,(e=>{a.material=e})))}c=Promise.all(o),i&&(r._instanceData={babylonSourceMesh:a,promise:c}),l=a}return Ve.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),o(l),this.logClose(),c.then((()=>l))}_loadVertexDataAsync(e,t,n){const s=this._extensionsLoadVertexDataAsync(e,t,n);if(s)return s;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const o=new Array,a=new K.Z(n.name,this._babylonScene);if(null==t.indices)n.isUnIndexed=!0;else{const n=ke.Get(`${e}/indices`,this._gltf.accessors,t.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${n.index}`,n).then((e=>{a.setIndices(e)})))}const i=(t,s,i)=>{if(null==r[t])return;n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(s)&&n._delayInfo.push(s);const l=ke.Get(`${e}/attributes/${t}`,this._gltf.accessors,r[t]);o.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,s).then((e=>{if(e.getKind()===H.o.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const e=l.min,t=l.max;if(void 0!==e&&void 0!==t){if(l.normalized&&5126!==l.componentType){let n=1;switch(l.componentType){case 5120:n=127;break;case 5121:n=255;break;case 5122:n=32767;break;case 5123:n=65535}for(let s=0;s<3;++s)e[s]=Math.max(e[s]/n,-1),t[s]=Math.max(t[s]/n,-1)}const n=C.jp.Vector3[0],s=C.jp.Vector3[1];n.copyFromFloats(...e),s.copyFromFloats(...t),a._boundingInfo=new Pe.j(n,s),a.useBoundingInfoFromGeometry=!0}}a.setVerticesBuffer(e,l.count)}))),s==H.o.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),i&&i(l)};return i("POSITION",H.o.PositionKind),i("NORMAL",H.o.NormalKind),i("TANGENT",H.o.TangentKind),i("TEXCOORD_0",H.o.UVKind),i("TEXCOORD_1",H.o.UV2Kind),i("TEXCOORD_2",H.o.UV3Kind),i("TEXCOORD_3",H.o.UV4Kind),i("TEXCOORD_4",H.o.UV5Kind),i("TEXCOORD_5",H.o.UV6Kind),i("JOINTS_0",H.o.MatricesIndicesKind),i("WEIGHTS_0",H.o.MatricesWeightsKind),i("JOINTS_1",H.o.MatricesIndicesExtraKind),i("WEIGHTS_1",H.o.MatricesWeightsExtraKind),i("COLOR_0",H.o.ColorKind,(e=>{"VEC4"===e.type&&(n.hasVertexAlpha=!0)})),Promise.all(o).then((()=>a))}_createMorphTargets(e,t,n,s,r){if(!s.targets)return;if(null==t._numMorphTargets)t._numMorphTargets=s.targets.length;else if(s.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=n.extras?n.extras.targetNames:null;r.morphTargetManager=new Ne.O(r.getScene()),r.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<s.targets.length;e++){const s=t.weights?t.weights[e]:n.weights?n.weights[e]:0,a=o?o[e]:`morphTarget${e}`;r.morphTargetManager.addTarget(new Re.Y(a,s,r.getScene()))}}_loadMorphTargetsAsync(e,t,n,s){if(!t.targets)return Promise.resolve();const r=new Array,o=n.morphTargetManager;for(let n=0;n<o.numTargets;n++){const a=o.getTarget(n);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${n}`,s,t.targets[n],a))}return Promise.all(r).then((()=>{o.areUpdatesFrozen=!1}))}_loadMorphTargetVertexDataAsync(e,t,n,s){const r=new Array,o=(s,o,a)=>{if(null==n[s])return;const i=t.getVertexBuffer(o);if(!i)return;const l=ke.Get(`${e}/${s}`,this._gltf.accessors,n[s]);r.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then((e=>{a(i,e)})))};return o("POSITION",H.o.PositionKind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,((e,s)=>{n[s]=t[s]+e})),s.setPositions(n)})),o("NORMAL",H.o.NormalKind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(n.length,((e,s)=>{n[s]=t[s]+e})),s.setNormals(n)})),o("TANGENT",H.o.TangentKind,((e,t)=>{const n=new Float32Array(t.length/3*4);let r=0;e.forEach(t.length/3*4,((e,s)=>{(s+1)%4!=0&&(n[r]=t[r]+e,r++)})),s.setTangents(n)})),Promise.all(r).then((()=>{}))}static _LoadTransform(e,t){if(null!=e.skin)return;let n=C.P.Zero(),s=C._f.Identity(),r=C.P.One();e.matrix?C.y3.FromArray(e.matrix).decompose(r,s,n):(e.translation&&(n=C.P.FromArray(e.translation)),e.rotation&&(s=C._f.FromArray(e.rotation)),e.scale&&(r=C.P.FromArray(e.scale))),t.position=n,t.rotationQuaternion=s,t.scaling=r}_loadSkinAsync(e,t,n,s){const r=this._extensionsLoadSkinAsync(e,t,n);if(r)return r;if(n._data)return s(n._data.babylonSkeleton),n._data.promise;const o=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new F.O(n.name||o,o,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,a);const i=this._loadSkinInverseBindMatricesDataAsync(e,n).then((e=>{this._updateBoneMatrices(a,e)}));return n._data={babylonSkeleton:a,promise:i},s(a),i}_loadBones(e,t,n){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const n=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(n)if(void 0===t.skeleton)t.skeleton=n.index;else{const s=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},r=ke.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);r===n||s(r,n)||(c.Y.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=n.index)}else c.Y.Warn(`${e}: Failed to find common root`)}const s={};for(const r of t.joints){const o=ke.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(o,t,n,s)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const n={};for(const s of t){const t=new Array;let r=ke.Get(`${e}/${s}`,this._gltf.nodes,s);for(;-1!==r.index;)t.unshift(r),r=r.parent;n[s]=t}let s=null;for(let e=0;;++e){let r=n[t[0]];if(e>=r.length)return s;const o=r[e];for(let a=1;a<t.length;++a)if(r=n[t[a]],e>=r.length||o!==r[e])return s;s=o}}_loadBone(e,t,n,s){let r=s[e.index];if(r)return r;let o=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?o=this._loadBone(e.parent,t,n,s):void 0!==t.skeleton&&c.Y.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new I.N(e.name||`joint${e.index}`,n,o,this._getNodeMatrix(e),null,null,a),s[e.index]=r,this._postSceneLoadActions.push((()=>{r.linkTransformNode(e._babylonTransformNode)})),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const n=ke.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const e=C.y3.Identity(),s=n._index;t&&-1!==s&&(C.y3.FromArrayToRef(t,16*s,e),e.invertToRef(e));const r=n.getParent();r&&e.multiplyToRef(r.getInvertedAbsoluteTransform(),e),n.updateMatrix(e,!1,!1),n._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(e){return e.matrix?C.y3.FromArray(e.matrix):C.y3.Compose(e.scale?C.P.FromArray(e.scale):C.P.One(),e.rotation?C._f.FromArray(e.rotation):C._f.Identity(),e.translation?C.P.FromArray(e.translation):C.P.Zero())}loadCameraAsync(e,t,n=(()=>{})){const s=this._extensionsLoadCameraAsync(e,t,n);if(s)return s;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new N.c(t.name||`camera${t.index}`,C.P.Zero(),this._babylonScene,!1);switch(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.ignoreParentScaling=!0,t._babylonCamera=o,o.rotation=new C.P(0,Math.PI,0),t.type){case"perspective":{const n=t.perspective;if(!n)throw new Error(`${e}: Camera perspective properties are missing`);o.fov=n.yfov,o.minZ=n.znear,o.maxZ=n.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);o.mode=R.V.ORTHOGRAPHIC_CAMERA,o.orthoLeft=-t.orthographic.xmag,o.orthoRight=t.orthographic.xmag,o.orthoBottom=-t.orthographic.ymag,o.orthoTop=t.orthographic.ymag,o.minZ=t.orthographic.znear,o.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return Ve.AddPointerMetadata(o,e),this._parent.onCameraLoadedObservable.notifyObservers(o),n(o),this.logClose(),Promise.all(r).then((()=>o))}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const s=e[n];t.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then((e=>{0===e.targetedAnimations.length&&e.dispose()})))}return Promise.all(t).then((()=>{}))}loadAnimationAsync(e,t){const n=this._extensionsLoadAnimationAsync(e,t);if(n)return n;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new ve.O(t.name||`animation${t.index}`,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=s;const r=new Array;ke.Assign(t.channels),ke.Assign(t.samplers);for(const n of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${n.index}`,e,t,n,((e,t)=>{e.animations=e.animations||[],e.animations.push(t),s.addTargetedAnimation(t,e)})));return Promise.all(r).then((()=>(s.normalize(0),s)))}_loadAnimationChannelAsync(e,t,n,s,r){const o=this._extensionsLoadAnimationChannelAsync(e,t,n,s,r);if(o)return o;if(null==s.target.node)return Promise.resolve();const a=ke.Get(`${e}/target/node`,this._gltf.nodes,s.target.node);if("weights"===s.target.path&&!a._numMorphTargets||"weights"!==s.target.path&&!a._babylonTransformNode)return Promise.resolve();let i;switch(s.target.path){case"translation":i=De.translation;break;case"rotation":i=De.rotation;break;case"scale":i=De.scale;break;case"weights":i=De.weights;break;default:throw new Error(`${e}/target/path: Invalid value (${s.target.path})`)}const l={target:a,properties:i};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,s,l,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,n,s,r,o){const a=this.parent.targetFps,i=1/a,l=ke.Get(`${e}/sampler`,n.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${s.sampler}`,l).then((e=>{let t=0;for(const l of r.properties){const c=l.getStride(r.target),d=e.input,h=e.output,u=new Array(d.length);let _=0;switch(e.interpolation){case"STEP":for(let e=0;e<d.length;e++){const t=l.getValue(r.target,h,_,1);_+=c,u[e]={frame:d[e]*a,value:t,interpolation:Le.N.STEP}}break;case"CUBICSPLINE":for(let e=0;e<d.length;e++){const t=l.getValue(r.target,h,_,i);_+=c;const n=l.getValue(r.target,h,_,1);_+=c;const s=l.getValue(r.target,h,_,i);_+=c,u[e]={frame:d[e]*a,inTangent:t,value:n,outTangent:s}}break;case"LINEAR":for(let e=0;e<d.length;e++){const t=l.getValue(r.target,h,_,1);_+=c,u[e]={frame:d[e]*a,value:t}}}if(_>0){const e=`${n.name||`animation${n.index}`}_channel${s.index}_${t}`;l.buildAnimations(r.target,e,a,u,((e,n)=>{++t,o(e,n)}))}}}))}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const s=ke.Get(`${e}/input`,this._gltf.accessors,t.input),r=ke.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then((([e,t])=>({input:e,interpolation:n,output:t}))),t._data}loadBufferAsync(e,t,n,s){const r=this._extensionsLoadBufferAsync(e,t,n,s);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then((t=>{try{return new Uint8Array(t.buffer,t.byteOffset+n,s)}catch(t){throw new Error(`${e}: ${t.message}`)}}))}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const s=ke.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${s.index}`,s,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const s=Ve._GetNumComponents(e,t.type),r=s*H.o.GetTypeByteLength(t.componentType),o=s*t.count;if(null==t.bufferView)t._data=Promise.resolve(new n(o));else{const a=ke.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then((i=>{if(5126!==t.componentType||t.normalized||a.byteStride&&a.byteStride!==r){const e=new n(o);return H.o.ForEach(i,t.byteOffset||0,a.byteStride||r,s,t.componentType,e.length,t.normalized||!1,((t,n)=>{e[n]=t})),e}return Ve._GetTypedArray(e,t.componentType,i,t.byteOffset,o)}))}if(t.sparse){const o=t.sparse;t._data=t._data.then((a=>{const i=a,l=ke.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),c=ke.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${c.index}`,c)]).then((([a,l])=>{const c=Ve._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,a,o.indices.byteOffset,o.count),d=s*o.count;let h;if(5126!==t.componentType||t.normalized){const a=Ve._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,d);h=new n(d),H.o.ForEach(a,0,r,s,t.componentType,h.length,t.normalized||!1,((e,t)=>{h[t]=e}))}else h=Ve._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,d);let u=0;for(let e=0;e<c.length;e++){let t=c[e]*s;for(let e=0;e<s;e++)i[t++]=h[u++]}return i}))}))}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=Ve._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=ke.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then((n=>Ve._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count)))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then((e=>new H.l(t,e,!1))),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){var s;if(null===(s=t._babylonVertexBuffer)||void 0===s?void 0:s[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then((e=>new H.o(r,e,n,!1)));else if(n===H.o.MatricesIndicesKind||n===H.o.MatricesIndicesExtraKind)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then((e=>new H.o(r,e,n,!1)));else{const s=ke.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(s).then((o=>{const a=Ve._GetNumComponents(e,t.type);return new H.o(r,o,n,!1,!1,s.byteStride,!1,t.byteOffset,a,t.componentType,t.normalized,!0,1,!0)}))}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return t&&(t.baseColorFactor?(n.albedoColor=S.Wo.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=S.Wo.White(),n.metallic=null==t.metallicFactor?1:t.metallicFactor,n.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,(e=>{e.name=`${n.name} (Base Color)`,n.albedoTexture=e}))),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,(e=>{e.name=`${n.name} (Metallic Roughness)`,n.metallicTexture=e}))),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then((()=>{}))}_loadMaterialAsync(e,t,n,s,r=(()=>{})){const o=this._extensionsLoadMaterialAsync(e,t,n,s,r);if(o)return o;t._data=t._data||{};let a=t._data[s];if(!a){this.logOpen(`${e} ${t.name||""}`);const n=this.createMaterial(e,t,s);a={babylonMaterial:n,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,n)},t._data[s]=a,Ve.AddPointerMetadata(n,e),this._parent.onMaterialLoadedObservable.notifyObservers(n),this.logClose()}return n&&(a.babylonMeshes.push(n),n.onDisposeObservable.addOnce((()=>{const e=a.babylonMeshes.indexOf(n);-1!==e&&a.babylonMeshes.splice(e,1)}))),r(a.babylonMaterial),a.promise.then((()=>a.babylonMaterial))}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Ce.Y(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=Ce.Y.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n}createMaterial(e,t,n){const s=this._extensionsCreateMaterial(e,t,n);if(s)return s;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,n)}loadMaterialPropertiesAsync(e,t,n){const s=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(s)return s;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(r).then((()=>{}))}loadMaterialBasePropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.emissiveColor=t.emissiveFactor?S.Wo.FromArray(t.emissiveFactor):new S.Wo(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,(e=>{e.name=`${n.name} (Normal)`,n.bumpTexture=e}))),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&n.bumpTexture&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,(e=>{e.name=`${n.name} (Occlusion)`,n.ambientTexture=e}))),n.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,(e=>{e.name=`${n.name} (Emissive)`,n.emissiveTexture=e}))),Promise.all(s).then((()=>{}))}loadMaterialAlphaProperties(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":n.transparencyMode=Ce.Y.PBRMATERIAL_OPAQUE;break;case"MASK":n.transparencyMode=Ce.Y.PBRMATERIAL_ALPHATEST,n.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break;case"BLEND":n.transparencyMode=Ce.Y.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=(()=>{})){const s=this._extensionsLoadTextureInfoAsync(e,t,n);if(s)return s;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=ke.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const o=this._loadTextureAsync(`/textures/${t.index}`,r,(s=>{s.coordinatesIndex=t.texCoord||0,Ve.AddPointerMetadata(s,e),this._parent.onTextureLoadedObservable.notifyObservers(s),n(s)}));return this.logClose(),o}_loadTextureAsync(e,t,n=(()=>{})){const s=this._extensionsLoadTextureAsync(e,t,n);if(s)return s;this.logOpen(`${e} ${t.name||""}`);const r=null==t.sampler?Ve.DefaultSampler:ke.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),o=ke.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,r,o,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,n,s=(()=>{}),r,o){const a=this._loadSampler(`/samplers/${t.index}`,t),i=new Array,l=new we.B;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||l.resolve()},onError:(t,n)=>{this._disposed||l.reject(new Error(`${e}: ${n&&n.message?n.message:t||"Failed to load texture"}`))},mimeType:n.mimeType,loaderOptions:r,useSRGBBuffer:!!o&&this._parent.useSRGBBuffers},d=new G.x(null,this._babylonScene,c);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.push(l.promise),i.push(this.loadImageAsync(`/images/${n.index}`,n).then((e=>{const t=n.uri||`${this._fileName}#image${n.index}`,s=`data:${this._uniqueRootUrl}${t}`;d.updateURL(s,e)}))),d.wrapU=a.wrapU,d.wrapV=a.wrapV,s(d),Promise.all(i).then((()=>d))}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:Ve._GetTextureSamplingMode(e,t),wrapU:Ve._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:Ve._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=ke.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const s=this._extensionsLoadUriAsync(e,t,n);if(s)return s;if(!Ve._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if((0,M.VL)(n)){const t=new Uint8Array((0,M.$K)(n));return this.log(`${e}: Decoded ${n.substr(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then((t=>new Promise(((s,r)=>{this._parent._loadFile(this._babylonScene,t,(t=>{this._disposed||(this.log(`${e}: Loaded ${n} (${t.byteLength} bytes)`),s(new Uint8Array(t)))}),!0,(t=>{r(new M.eh(`${e}: Failed to load '${n}'${t?": "+t.status+" "+t.statusText:""}`,t))}))}))))}static AddPointerMetadata(e,t){const n=e.metadata=e.metadata||{},s=n.gltf=n.gltf||{};(s.pointers=s.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return G.x.CLAMP_ADDRESSMODE;case 33648:return G.x.MIRROR_ADDRESSMODE;case 10497:return G.x.WRAP_ADDRESSMODE;default:return c.Y.Warn(`${e}: Invalid value (${t})`),G.x.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=null==t.magFilter?9729:t.magFilter,s=null==t.minFilter?9987:t.minFilter;if(9729===n)switch(s){case 9728:return G.x.LINEAR_NEAREST;case 9729:return G.x.LINEAR_LINEAR;case 9984:return G.x.LINEAR_NEAREST_MIPNEAREST;case 9985:return G.x.LINEAR_LINEAR_MIPNEAREST;case 9986:return G.x.LINEAR_NEAREST_MIPLINEAR;case 9987:return G.x.LINEAR_LINEAR_MIPLINEAR;default:return c.Y.Warn(`${e}/minFilter: Invalid value (${s})`),G.x.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==n&&c.Y.Warn(`${e}/magFilter: Invalid value (${n})`),s){case 9728:return G.x.NEAREST_NEAREST;case 9729:return G.x.NEAREST_LINEAR;case 9984:return G.x.NEAREST_NEAREST_MIPNEAREST;case 9985:return G.x.NEAREST_LINEAR_MIPNEAREST;case 9986:return G.x.NEAREST_NEAREST_MIPLINEAR;case 9987:return G.x.NEAREST_LINEAR_MIPLINEAR;default:return c.Y.Warn(`${e}/minFilter: Invalid value (${s})`),G.x.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,n,s,r){const o=n.buffer;s=n.byteOffset+(s||0);const a=Ve._GetTypedArrayConstructor(`${e}/componentType`,t),i=H.o.GetTypeByteLength(t);return s%i!=0?(c.Y.Warn(`${e}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${i})`),new a(o.slice(s,s+r*i),0)):new a(o,s,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return a.w1.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return D.F.PointListDrawMode;case 1:return D.F.LineListDrawMode;case 2:return D.F.LineLoopDrawMode;case 3:return D.F.LineStripDrawMode;case 4:return D.F.TriangleFillMode;case 5:return D.F.TriangleStripDrawMode;case 6:return D.F.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const s=t._data[n];for(const t of s.babylonMeshes){t.computeWorldMatrix(!0);const n=s.babylonMaterial;e.push(n.forceCompilationAsync(t)),e.push(n.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(n.forceCompilationAsync(t,{clipPlane:!0})),e.push(n.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile materials")}))}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const t=n.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile shadow generators")}))}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const s of this._extensions)if(s.enabled){const r=`${s.name}.${t}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const a=o._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const e=n(s);if(e)return e}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions((e=>e.onLoading&&e.onLoading()))}_extensionsOnReady(){this._forEachExtensions((e=>e.onReady&&e.onReady()))}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",(n=>n.loadSceneAsync&&n.loadSceneAsync(e,t)))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",(s=>s.loadNodeAsync&&s.loadNodeAsync(e,t,n)))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",(s=>s.loadCameraAsync&&s.loadCameraAsync(e,t,n)))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",(s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(e,t,n)))}_extensionsLoadMeshPrimitiveAsync(e,t,n,s,r,o){return this._applyExtensions(r,"loadMeshPrimitive",(a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,n,s,r,o)))}_extensionsLoadMaterialAsync(e,t,n,s,r){return this._applyExtensions(t,"loadMaterial",(o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,t,n,s,r)))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",(s=>s.createMaterial&&s.createMaterial(e,t,n)))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",(s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,t,n)))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",(s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,t,n)))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",(s=>s._loadTextureAsync&&s._loadTextureAsync(e,t,n)))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",(n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t)))}_extensionsLoadAnimationChannelAsync(e,t,n,s,r){return this._applyExtensions(n,"loadAnimationChannel",(o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,t,n,s,r)))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",(s=>s._loadSkinAsync&&s._loadSkinAsync(e,t,n)))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",(s=>s._loadUriAsync&&s._loadUriAsync(e,t,n)))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",(n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t)))}_extensionsLoadBufferAsync(e,t,n,s){return this._applyExtensions(t,"loadBuffer",(r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,n,s)))}static LoadExtensionAsync(e,t,n,s){if(!t.extensions)return null;const r=t.extensions[n];return r?s(`${e}/extensions/${n}`,r):null}static LoadExtraAsync(e,t,n,s){if(!t.extras)return null;const r=t.extras[n];return r?s(`${e}/extras/${n}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}Ve._RegisteredExtensions={},Ve.DefaultSampler={index:-1},v._CreateGLTF2Loader=e=>new Ve(e);var Ge=n(1865),Ue=n(3375),He=n(1011);const Ke="EXT_lights_image_based";class We{constructor(e){this.name=Ke,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ke)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return Ve.LoadExtensionAsync(e,t,this.name,((n,s)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const o=ke.Get(`${n}/light`,this._lights,s.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,o).then((e=>{this._loader.babylonScene.environmentTexture=e}))),this._loader.logClose(),Promise.all(r).then((()=>{}))}))}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const s=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const o=t.specularImages[r];s[r]=new Array(o.length);for(let t=0;t<o.length;t++){const a=`${e}/specularImages/${r}/${t}`;this._loader.logOpen(`${a}`);const i=o[t],l=ke.Get(a,this._loader.gltf.images,i);n.push(this._loader.loadImageAsync(`/images/${i}`,l).then((e=>{s[r][t]=e}))),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then((()=>{const n=new He.N(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,null!=t.intensity&&(n.level=t.intensity),t.rotation){let e=C._f.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=C._f.Inverse(e)),C.y3.FromQuaternionToRef(e,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const r=Ue._.FromArray(t.irradianceCoefficients);r.scaleInPlace(t.intensity),r.convertIrradianceToLambertianRadiance();const o=Ue.i.FromHarmonics(r),a=(s.length-1)/Ge.R.Log2(t.specularImageSize);return n.updateRGBDAsync(s,o,a)}))}return t._loaded.then((()=>t._babylonTexture))}}Ve.RegisterExtension(Ke,(e=>new We(e))),n(7709);const Ye="EXT_mesh_gpu_instancing";class je{constructor(e){this.name=Ye,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((e,s)=>{this._loader._disableInstancedMesh++;const r=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return r;const o=new Array;let a=0;const i=t=>{if(null==s.attributes[t])return void o.push(Promise.resolve(null));const n=ke.Get(`${e}/attributes/${t}`,this._loader.gltf.accessors,s.attributes[t]);if(o.push(this._loader._loadFloatAccessorAsync(`/accessors/${n.bufferView}`,n)),0===a)a=n.count;else if(a!==n.count)throw new Error(`${e}/attributes: Instance buffer accessors do not have the same count.`)};return i("TRANSLATION"),i("ROTATION"),i("SCALE"),r.then((e=>Promise.all(o).then((([n,s,r])=>{const o=new Float32Array(16*a);C.jp.Vector3[0].copyFromFloats(0,0,0),C.jp.Quaternion[0].copyFromFloats(0,0,0,1),C.jp.Vector3[1].copyFromFloats(1,1,1);for(let e=0;e<a;++e)n&&C.P.FromArrayToRef(n,3*e,C.jp.Vector3[0]),s&&C._f.FromArrayToRef(s,4*e,C.jp.Quaternion[0]),r&&C.P.FromArrayToRef(r,3*e,C.jp.Vector3[1]),C.y3.ComposeToRef(C.jp.Vector3[1],C.jp.Quaternion[0],C.jp.Vector3[0],C.jp.Matrix[0]),C.jp.Matrix[0].copyToArray(o,16*e);for(const e of t._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",o,16,!0);return e}))))}))}}Ve.RegisterExtension(Ye,(e=>new je(e)));var qe=n(3908);const Xe="EXT_meshopt_compression";class Ze{constructor(e){this.name=Xe,this.enabled=e.isExtensionUsed(Xe),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return Ve.LoadExtensionAsync(e,t,this.name,((n,s)=>{const r=t;if(r._meshOptData)return r._meshOptData;const o=ke.Get(`${e}/buffer`,this._loader.gltf.buffers,s.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,s.byteOffset||0,s.byteLength).then((e=>qe.K.Default.decodeGltfBufferAsync(e,s.count,s.byteStride,s.mode,s.filter))),r._meshOptData}))}}Ve.RegisterExtension(Xe,(e=>new Ze(e)));const Je="EXT_texture_webp";class ze{constructor(e){this.name=Je,this._loader=e,this.enabled=e.isExtensionUsed(Je)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=null==t.sampler?Ve.DefaultSampler:ke.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=ke.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,(e=>{n(e)}),void 0,!t._textureInfo.nonColorData)}))}}Ve.RegisterExtension(Je,(e=>new ze(e)));var Qe=n(7181);const et="KHR_draco_mesh_compression";class tt{constructor(e){this.name=et,this._loader=e,this.enabled=Qe.J.DecoderAvailable&&this._loader.isExtensionUsed(et)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{if(null!=t.mode){if(5!==t.mode&&4!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(5===t.mode)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const o={},a={},i=(s,i)=>{const l=r.attributes[s];if(void 0===l||void 0===t.attributes[s])return;o[i]=l;const c=ke.Get(`${e}/attributes/${s}`,this._loader.gltf.accessors,t.attributes[s]);if(c.normalized&&5126!==c.componentType){let e=1;switch(c.componentType){case 5120:e=127;break;case 5121:e=255;break;case 5122:e=32767;break;case 5123:e=65535}a[i]=e}n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(i)&&n._delayInfo.push(i)};i("POSITION",H.o.PositionKind),i("NORMAL",H.o.NormalKind),i("TANGENT",H.o.TangentKind),i("TEXCOORD_0",H.o.UVKind),i("TEXCOORD_1",H.o.UV2Kind),i("TEXCOORD_2",H.o.UV3Kind),i("TEXCOORD_3",H.o.UV4Kind),i("TEXCOORD_4",H.o.UV5Kind),i("TEXCOORD_5",H.o.UV6Kind),i("JOINTS_0",H.o.MatricesIndicesKind),i("WEIGHTS_0",H.o.MatricesWeightsKind),i("COLOR_0",H.o.ColorKind);const l=ke.Get(s,this._loader.gltf.bufferViews,r.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then((t=>(this.dracoCompression||Qe.J.Default).decodeMeshAsync(t,o,a).then((e=>{const t=new K.Z(n.name,this._loader.babylonScene);return e.applyToGeometry(t),t})).catch((t=>{throw new Error(`${e}: ${t.message}`)}))))),l._dracoBabylonGeometry}))}}Ve.RegisterExtension(et,(e=>new tt(e)));var nt=n(5046);const st="KHR_lights_punctual";class rt{constructor(e){this.name=st,this._loader=e,this.enabled=this._loader.isExtensionUsed(st)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,ke.Assign(this._lights)}}loadNodeAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>this._loader.loadNodeAsync(e,t,(e=>{let t;const o=ke.Get(s,this._lights,r.light),a=o.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,o.type){case"directional":t=new X.O(a,C.P.Backward(),this._loader.babylonScene);break;case"point":t=new Z.c(a,C.P.Zero(),this._loader.babylonScene);break;case"spot":{const e=new J.P(a,C.P.Zero(),C.P.Backward(),0,1,this._loader.babylonScene);e.angle=2*(o.spot&&o.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(o.spot&&o.spot.innerConeAngle||0),t=e;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${s}: Invalid light type (${o.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=t,t.falloffType=nt._.FALLOFF_GLTF,t.diffuse=o.color?S.Wo.FromArray(o.color):S.Wo.White(),t.intensity=null==o.intensity?1:o.intensity,t.range=null==o.range?Number.MAX_VALUE:o.range,t.parent=e,this._loader._babylonLights.push(t),Ve.AddPointerMetadata(t,s),n(e)}))))}}Ve.RegisterExtension(st,(e=>new rt(e)));const ot="KHR_materials_pbrSpecularGlossiness";class at{constructor(e){this.name=ot,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(ot)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),o.push(this._loadSpecularGlossinessPropertiesAsync(s,t,r,n)),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then((()=>{}))}))}_loadSpecularGlossinessPropertiesAsync(e,t,n,s){if(!(s instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const r=new Array;return s.metallic=null,s.roughness=null,n.diffuseFactor?(s.albedoColor=S.Wo.FromArray(n.diffuseFactor),s.alpha=n.diffuseFactor[3]):s.albedoColor=S.Wo.White(),s.reflectivityColor=n.specularFactor?S.Wo.FromArray(n.specularFactor):S.Wo.White(),s.microSurface=null==n.glossinessFactor?1:n.glossinessFactor,n.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,n.diffuseTexture,(e=>{e.name=`${s.name} (Diffuse)`,s.albedoTexture=e}))),n.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,n.specularGlossinessTexture,(e=>{e.name=`${s.name} (Specular Glossiness)`,s.reflectivityTexture=e,s.reflectivityTexture.hasAlpha=!0}))),s.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then((()=>{}))}}Ve.RegisterExtension(ot,(e=>new at(e)));const it="KHR_materials_unlit";class lt{constructor(e){this.name=it,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(it)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,(()=>this._loadUnlitPropertiesAsync(e,t,n)))}_loadUnlitPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;n.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(n.albedoColor=S.Wo.FromArray(r.baseColorFactor),n.alpha=r.baseColorFactor[3]):n.albedoColor=S.Wo.White(),r.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,(e=>{e.name=`${n.name} (Base Color)`,n.albedoTexture=e})))),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(s).then((()=>{}))}}Ve.RegisterExtension(it,(e=>new lt(e)));const ct="KHR_materials_clearcoat";class dt{constructor(e){this.name=ct,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ct)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadClearCoatPropertiesAsync(s,r,n)),Promise.all(o).then((()=>{}))}))}_loadClearCoatPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.clearCoat.isEnabled=!0,n.clearCoat.useRoughnessFromMainTexture=!1,n.clearCoat.remapF0OnInterfaceChange=!1,null!=t.clearcoatFactor?n.clearCoat.intensity=t.clearcoatFactor:n.clearCoat.intensity=0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,(e=>{e.name=`${n.name} (ClearCoat Intensity)`,n.clearCoat.texture=e}))),null!=t.clearcoatRoughnessFactor?n.clearCoat.roughness=t.clearcoatRoughnessFactor:n.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,(e=>{e.name=`${n.name} (ClearCoat Roughness)`,n.clearCoat.textureRoughness=e})))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,(e=>{e.name=`${n.name} (ClearCoat Normal)`,n.clearCoat.bumpTexture=e}))),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,null!=t.clearcoatNormalTexture.scale&&(n.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(s).then((()=>{}))}}Ve.RegisterExtension(ct,(e=>new dt(e)));const ht="KHR_materials_iridescence";class ut{constructor(e){this.name=ht,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ht)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadIridescencePropertiesAsync(s,r,n)),Promise.all(o).then((()=>{}))}))}_loadIridescencePropertiesAsync(e,t,n){var s,r,o,a,i;if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const l=new Array;return n.iridescence.isEnabled=!0,n.iridescence.intensity=null!==(s=t.iridescenceFactor)&&void 0!==s?s:0,n.iridescence.indexOfRefraction=null!==(o=null!==(r=t.iridescenceIor)&&void 0!==r?r:t.iridescenceIOR)&&void 0!==o?o:1.3,n.iridescence.minimumThickness=null!==(a=t.iridescenceThicknessMinimum)&&void 0!==a?a:100,n.iridescence.maximumThickness=null!==(i=t.iridescenceThicknessMaximum)&&void 0!==i?i:400,t.iridescenceTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,(e=>{e.name=`${n.name} (Iridescence Intensity)`,n.iridescence.texture=e}))),t.iridescenceThicknessTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,(e=>{e.name=`${n.name} (Iridescence Thickness)`,n.iridescence.thicknessTexture=e}))),Promise.all(l).then((()=>{}))}}Ve.RegisterExtension(ht,(e=>new ut(e)));const _t="KHR_materials_emissive_strength";class mt{constructor(e){this.name=_t,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>this._loader.loadMaterialPropertiesAsync(e,t,n).then((()=>{this._loadEmissiveProperties(s,r,n)}))))}_loadEmissiveProperties(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);void 0!==t.emissiveStrength&&n.emissiveColor.scaleToRef(t.emissiveStrength,n.emissiveColor)}}Ve.RegisterExtension(_t,(e=>new mt(e)));const ft="KHR_materials_sheen";class pt{constructor(e){this.name=ft,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ft)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadSheenPropertiesAsync(s,r,n)),Promise.all(o).then((()=>{}))}))}_loadSheenPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.sheen.isEnabled=!0,n.sheen.intensity=1,null!=t.sheenColorFactor?n.sheen.color=S.Wo.FromArray(t.sheenColorFactor):n.sheen.color=S.Wo.Black(),t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,(e=>{e.name=`${n.name} (Sheen Color)`,n.sheen.texture=e}))),void 0!==t.sheenRoughnessFactor?n.sheen.roughness=t.sheenRoughnessFactor:n.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,(e=>{e.name=`${n.name} (Sheen Roughness)`,n.sheen.textureRoughness=e})))),n.sheen.albedoScaling=!0,n.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then((()=>{}))}}Ve.RegisterExtension(ft,(e=>new pt(e)));const yt="KHR_materials_specular";class At{constructor(e){this.name=yt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(yt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadSpecularPropertiesAsync(s,r,n)),Promise.all(o).then((()=>{}))}))}_loadSpecularPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return void 0!==t.specularFactor&&(n.metallicF0Factor=t.specularFactor),void 0!==t.specularColorFactor&&(n.metallicReflectanceColor=S.Wo.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,(e=>{e.name=`${n.name} (Specular F0 Strength)`,n.metallicReflectanceTexture=e,n.useOnlyMetallicFromMetallicReflectanceTexture=!0})))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,(e=>{e.name=`${n.name} (Specular F0 Color)`,n.reflectanceTexture=e}))),Promise.all(s).then((()=>{}))}}Ve.RegisterExtension(yt,(e=>new At(e)));const bt="KHR_materials_ior";class gt{constructor(e){this.name=bt,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(bt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadIorPropertiesAsync(s,r,n)),Promise.all(o).then((()=>{}))}))}_loadIorPropertiesAsync(e,t,n){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);return void 0!==t.ior?n.indexOfRefraction=t.ior:n.indexOfRefraction=gt._DEFAULT_IOR,Promise.resolve()}}gt._DEFAULT_IOR=1.5,Ve.RegisterExtension(bt,(e=>new gt(e)));const Tt="KHR_materials_variants";class Et{constructor(e){this.name=Tt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tt)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return Et.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot select variant on a glTF mesh that does not have the KHR_materials_variants extension");const s=e=>{const t=n.variants[e];if(t)for(const e of t)e.mesh.material=e.material};if(t instanceof Array)for(const e of t)s(e);else s(t);n.lastSelected=t}selectVariant(e,t){return Et.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot reset on a glTF mesh that does not have the KHR_materials_variants extension");for(const e of t.original)e.mesh.material=e.material;t.lastSelected=null}reset(e){return Et.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the KHR_materials_variants extension");return t.lastSelected}getLastSelectedVariant(e){return Et.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,n;return(null===(n=null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.gltf)||void 0===n?void 0:n.KHR_materials_variants)||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,n,s,r,o){return Ve.LoadExtensionAsync(e,r,this.name,((a,i)=>{const l=new Array;return l.push(this._loader._loadMeshPrimitiveAsync(e,t,n,s,r,(t=>{if(o(t),t instanceof j.Kj){const n=Ve._GetDrawMode(e,r.mode),s=this._loader.rootBabylonMesh,o=s?s.metadata=s.metadata||{}:{},c=o.gltf=o.gltf||{},d=c.KHR_materials_variants=c.KHR_materials_variants||{lastSelected:null,original:[],variants:{}};d.original.push({mesh:t,material:t.material});for(let e=0;e<i.mappings.length;++e){const r=i.mappings[e],o=ke.Get(`${a}/mappings/${e}/material`,this._loader.gltf.materials,r.material);l.push(this._loader._loadMaterialAsync(`#/materials/${r.material}`,o,t,n,(e=>{for(let n=0;n<r.variants.length;++n){const o=r.variants[n],a=ke.Get(`/extensions/KHR_materials_variants/variants/${o}`,this._variants,o);d.variants[a.name]=d.variants[a.name]||[],d.variants[a.name].push({mesh:t,material:e}),t.onClonedObservable.add((e=>{const n=e;let r=null,o=n;do{if(o=o.parent,!o)return;r=Et._GetExtensionMetadata(o)}while(null===r);if(s&&r===Et._GetExtensionMetadata(s)){o.metadata={};for(const e in s.metadata)o.metadata[e]=s.metadata[e];o.metadata.gltf=[];for(const e in s.metadata.gltf)o.metadata.gltf[e]=s.metadata.gltf[e];o.metadata.gltf.KHR_materials_variants={lastSelected:null,original:[],variants:{}};for(const e of r.original)o.metadata.gltf.KHR_materials_variants.original.push({mesh:e.mesh,material:e.material});for(const e in r.variants)if(Object.prototype.hasOwnProperty.call(r.variants,e)){o.metadata.gltf.KHR_materials_variants.variants[e]=[];for(const t of r.variants[e])o.metadata.gltf.KHR_materials_variants.variants[e].push({mesh:t.mesh,material:t.material})}r=o.metadata.gltf.KHR_materials_variants}for(const e of r.original)e.mesh===t&&(e.mesh=n);for(const e of r.variants[a.name])e.mesh===t&&(e.mesh=n)}))}})))}}}))),Promise.all(l).then((([e])=>e))}))}}Ve.RegisterExtension(Tt,(e=>new Et(e)));var xt=n(3073);class Ot{constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Ot._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new o.y$,this._scene.onDisposeObservable.addOnce((()=>{this.dispose()})),this._parseScene(),this._setupRenderTargets()}static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ee.g.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}updateOptions(e){if(!Object.keys(e).filter((t=>this._options[t]!==e[t])).length)return;const t={...this._options,...e},n=this._options;this._options=t,t.renderSize===n.renderSize&&t.renderTargetTextureType===n.renderTargetTextureType&&t.generateMipmaps===n.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e&&!!(e instanceof Ce.Y&&e.subSurface.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),a.w1.SetImmediate((()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.push(e)}))}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),-1!==t&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Ce.Y&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==n?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)):-1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===n&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;let n,s;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new xt._("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=null!==(t=null===(e=this._options.clearColor)||void 0===e?void 0:e.clone())&&void 0!==t?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.onBeforeBindObservable.add((e=>{s=this._scene.environmentIntensity,this._scene.environmentIntensity=1,n=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?e.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(e.clearColor),this._scene.imageProcessingConfiguration._applyByPostProcess=!0})),this._opaqueRenderTarget.onAfterUnbindObservable.add((()=>{this._scene.environmentIntensity=s,this._scene.imageProcessingConfiguration._applyByPostProcess=n})),this._transparentMeshesCache.forEach((e=>{this._shouldRenderAsTransmission(e.material)&&(e.material.refractionTexture=this._opaqueRenderTarget)}))}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Mt="KHR_materials_transmission";class wt{constructor(e){this.name=Mt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadTransparentPropertiesAsync(s,t,n,r)),Promise.all(o).then((()=>{}))}))}_loadTransparentPropertiesAsync(e,t,n,s){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const r=n;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,void 0===s.transmissionFactor)return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();{r.subSurface.refractionIntensity=s.transmissionFactor;const e=r.getScene();r.subSurface.refractionIntensity&&!e._transmissionHelper&&new Ot({},r.getScene())}return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,s.transmissionTexture,void 0).then((e=>{r.subSurface.refractionIntensityTexture=e,r.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}Ve.RegisterExtension(Mt,(e=>new wt(e)));const Lt="KHR_materials_translucency";class vt{constructor(e){this.name=Lt,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadTranslucentPropertiesAsync(s,t,n,r)),Promise.all(o).then((()=>{}))}))}_loadTranslucentPropertiesAsync(e,t,n,s){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);const r=n;return r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,void 0===s.translucencyFactor?(r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve()):(r.subSurface.translucencyIntensity=s.translucencyFactor,s.translucencyTexture?(s.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,s.translucencyTexture).then((e=>{r.subSurface.translucencyIntensityTexture=e}))):Promise.resolve())}}Ve.RegisterExtension(Lt,(e=>new vt(e)));const Ct="KHR_materials_volume";class St{constructor(e){this.name=Ct,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ct),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadVolumePropertiesAsync(s,t,n,r)),Promise.all(o).then((()=>{}))}))}_loadVolumePropertiesAsync(e,t,n,s){if(!(n instanceof Ce.Y))throw new Error(`${e}: Material type not supported`);if(!n.subSurface.isRefractionEnabled&&!n.subSurface.isTranslucencyEnabled||!s.thicknessFactor)return Promise.resolve();n.subSurface.volumeIndexOfRefraction=n.indexOfRefraction;const r=void 0!==s.attenuationDistance?s.attenuationDistance:Number.MAX_VALUE;return n.subSurface.tintColorAtDistance=r,void 0!==s.attenuationColor&&3==s.attenuationColor.length&&n.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=s.thicknessFactor,n.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,s.thicknessTexture).then((e=>{n.subSurface.thicknessTexture=e,n.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}Ve.RegisterExtension(Ct,(e=>new St(e)));const Rt="KHR_mesh_quantization";class Nt{constructor(e){this.name=Rt,this.enabled=e.isExtensionUsed(Rt)}dispose(){}}Ve.RegisterExtension(Rt,(e=>new Nt(e)));const Pt="KHR_texture_basisu";class It{constructor(e){this.name=Pt,this._loader=e,this.enabled=e.isExtensionUsed(Pt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>{const o=null==t.sampler?Ve.DefaultSampler:ke.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=ke.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,(e=>{n(e)}),t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)}))}}Ve.RegisterExtension(Pt,(e=>new It(e)));const Ft="KHR_texture_transform";class $t{constructor(e){this.name=Ft,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ft)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((s,r)=>this._loader.loadTextureInfoAsync(e,t,(e=>{if(!(e instanceof G.x))throw new Error(`${s}: Texture type not supported`);r.offset&&(e.uOffset=r.offset[0],e.vOffset=r.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,r.rotation&&(e.wAng=-r.rotation),r.scale&&(e.uScale=r.scale[0],e.vScale=r.scale[1]),null!=r.texCoord&&(e.coordinatesIndex=r.texCoord),n(e)}))))}}Ve.RegisterExtension(Ft,(e=>new $t(e)));const Dt="KHR_xmp_json_ld";class Bt{constructor(e){this.name=Dt,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Dt)}dispose(){this._loader=null}onLoading(){var e,t,n;if(null===this._loader.rootBabylonMesh)return;const s=null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_xmp_json_ld,r=null===(n=null===(t=this._loader.gltf.asset)||void 0===t?void 0:t.extensions)||void 0===n?void 0:n.KHR_xmp_json_ld;if(s&&r){const e=+r.packet;s.packets&&e<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[e])}}}function kt(e,t,n,s){return S.Wo.FromArray(t,n).scale(s)}function Vt(e,t,n,s){return t[n]*s}function Gt(e,t,n,s){return-t[n]*s}function Ut(e,t,n,s){return t[n+1]*s}function Ht(e,t,n,s){return t[n]*s*2}function Kt(e){return{scale:[new Yt(P.f.ANIMATIONTYPE_FLOAT,`${e}.uScale`,Vt,(()=>2)),new Yt(P.f.ANIMATIONTYPE_FLOAT,`${e}.vScale`,Ut,(()=>2))],offset:[new Yt(P.f.ANIMATIONTYPE_FLOAT,`${e}.uOffset`,Vt,(()=>2)),new Yt(P.f.ANIMATIONTYPE_FLOAT,`${e}.vOffset`,Ut,(()=>2))],rotation:[new Yt(P.f.ANIMATIONTYPE_FLOAT,`${e}.wAng`,Gt,(()=>1))]}}Ve.RegisterExtension(Dt,(e=>new Bt(e)));class Wt extends Fe{buildAnimations(e,t,n,s,r){r(e._babylonCamera,this._buildAnimation(t,n,s))}}class Yt extends Fe{buildAnimations(e,t,n,s,r){for(const o in e._data)r(e._data[o].babylonMaterial,this._buildAnimation(t,n,s))}}class jt extends Fe{buildAnimations(e,t,n,s,r){r(e._babylonLight,this._buildAnimation(t,n,s))}}const qt={__array__:{__target__:!0,...De}},Xt={__array__:{__target__:!0,orthographic:{xmag:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"orthoLeft",Gt,(()=>1)),new Wt(P.f.ANIMATIONTYPE_FLOAT,"orthoRight",Ut,(()=>1))],ymag:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"orthoBottom",Gt,(()=>1)),new Wt(P.f.ANIMATIONTYPE_FLOAT,"orthoTop",Ut,(()=>1))],zfar:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"maxZ",Vt,(()=>1))],znear:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"minZ",Vt,(()=>1))]},perspective:{yfov:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"fov",Vt,(()=>1))],zfar:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"maxZ",Vt,(()=>1))],znear:[new Wt(P.f.ANIMATIONTYPE_FLOAT,"minZ",Vt,(()=>1))]}}},Zt={nodes:qt,materials:{__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new Yt(P.f.ANIMATIONTYPE_COLOR3,"albedoColor",kt,(()=>4)),new Yt(P.f.ANIMATIONTYPE_FLOAT,"alpha",(function(e,t,n,s){return t[n+3]*s}),(()=>4))],metallicFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"metallic",Vt,(()=>1))],roughnessFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"roughness",Vt,(()=>1))],baseColorTexture:{extensions:{KHR_texture_transform:Kt("albedoTexture")}}},emissiveFactor:[new Yt(P.f.ANIMATIONTYPE_COLOR3,"emissiveColor",kt,(()=>3))],normalTexture:{scale:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Vt,(()=>1))]},occlusionTexture:{strength:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Vt,(()=>1))],extensions:{KHR_texture_transform:Kt("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:Kt("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Vt,(()=>1))]},KHR_materials_clearcoat:{clearcoatFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Vt,(()=>1))],clearcoatRoughnessFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Vt,(()=>1))]},KHR_materials_sheen:{sheenColorFactor:[new Yt(P.f.ANIMATIONTYPE_COLOR3,"sheen.color",kt,(()=>3))],sheenRoughnessFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"sheen.roughness",Vt,(()=>1))]},KHR_materials_specular:{specularFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Vt,(()=>1))],specularColorFactor:[new Yt(P.f.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",kt,(()=>3))]},KHR_materials_emissive_strength:{emissiveStrength:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Vt,(()=>1))]},KHR_materials_transmission:{transmissionFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Vt,(()=>1))]},KHR_materials_volume:{attenuationColor:[new Yt(P.f.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",kt,(()=>3))],attenuationDistance:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Vt,(()=>1))],thicknessFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Vt,(()=>1))]},KHR_materials_iridescence:{iridescenceFactor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Vt,(()=>1))],iridescenceIor:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Vt,(()=>1))],iridescenceThicknessMinimum:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Vt,(()=>1))],iridescenceThicknessMaximum:[new Yt(P.f.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Vt,(()=>1))]}}}},cameras:Xt,extensions:{KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new jt(P.f.ANIMATIONTYPE_COLOR3,"diffuse",kt,(()=>3))],intensity:[new jt(P.f.ANIMATIONTYPE_FLOAT,"intensity",Vt,(()=>1))],range:[new jt(P.f.ANIMATIONTYPE_FLOAT,"range",Vt,(()=>1))],spot:{innerConeAngle:[new jt(P.f.ANIMATIONTYPE_FLOAT,"innerAngle",Ht,(()=>1))],outerConeAngle:[new jt(P.f.ANIMATIONTYPE_FLOAT,"angle",Ht,(()=>1))]}}}}}},Jt="KHR_animation_pointer";class zt{constructor(e){this.name=Jt,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Jt)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,n,s,r){var o;const a=null===(o=s.target.extensions)||void 0===o?void 0:o.KHR_animation_pointer;if(!a)return null;"pointer"!==s.target.path&&c.Y.Warn(`${e}/target/path: Value (${s.target.path}) must be (pointer) when using the ${this.name} extension`),null!=s.target.node&&c.Y.Warn(`${e}/target/node: Value (${s.target.node}) must not be present when using the ${this.name} extension`);const i=`${e}/extensions/${this.name}`,l=a.pointer;if(!l)throw new Error(`${i}: Pointer is missing`);const d=this._parseAnimationPointer(`${i}/pointer`,l);return d?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,s,d,r):(c.Y.Warn(`${i}/pointer: Invalid pointer (${l}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return c.Y.Warn(`${e}: Value (${t}) must start with a slash`),null;const n=t.split("/");n.shift();let s,r=Zt,o=this._loader.gltf;for(const e of n){if(r.__array__)r=r.__array__;else if(r=r[e],!r)return null;o=o&&o[e],r.__target__&&(s=o)}return s&&Array.isArray(r)?{target:s,properties:r}:null}}Ve.RegisterExtension(Jt,(e=>new zt(e)));var Qt=n(4867),en=n(749),tn=n(3357);const nn="MSFT_audio_emitter";class sn{constructor(e){this.name=nn,this._loader=e,this.enabled=this._loader.isExtensionUsed(nn)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,ke.Assign(this._clips),ke.Assign(this._emitters)}}loadSceneAsync(e,t){return Ve.LoadExtensionAsync(e,t,this.name,((n,s)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const e of s.emitters){const t=ke.Get(`${n}/emitters`,this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${n}/emitters/${t.index}`,t))}return Promise.all(r).then((()=>{}))}))}loadNodeAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((e,s)=>{const r=new Array;return this._loader.loadNodeAsync(e,t,(t=>{for(const n of s.emitters){const s=ke.Get(`${e}/emitters`,this._emitters,n);r.push(this._loadEmitterAsync(`${e}/emitters/${s.index}`,s).then((()=>{for(const e of s._babylonSounds)e.attachToMesh(t),null==s.innerAngle&&null==s.outerAngle||(e.setLocalDirectionToMesh(C.P.Forward()),e.setDirectionalCone(2*a.w1.ToDegrees(null==s.innerAngle?Math.PI:s.innerAngle),2*a.w1.ToDegrees(null==s.outerAngle?Math.PI:s.outerAngle),0))})))}n(t)})).then((e=>Promise.all(r).then((()=>e))))}))}loadAnimationAsync(e,t){return Ve.LoadExtensionAsync(e,t,this.name,((n,s)=>this._loader.loadAnimationAsync(e,t).then((r=>{const o=new Array;ke.Assign(s.events);for(const a of s.events)o.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,e,t,a,r));return Promise.all(o).then((()=>r))}))))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const s=ke.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=n.then((e=>URL.createObjectURL(new Blob([e],{type:t.mimeType})))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,n=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:null==t.volume?1:t.volume};for(let r=0;r<t.clips.length;r++){const o=`/extensions/${this.name}/clips`,a=ke.Get(o,this._clips,t.clips[r].clip);e.push(this._loadClipAsync(`${o}/${t.clips[r].clip}`,a).then((e=>{const o=t._babylonSounds[r]=new en.$(n,e,this._loader.babylonScene,null,s);o.refDistance=t.refDistance||1,o.maxDistance=t.maxDistance||256,o.rolloffFactor=t.rolloffFactor||1,o.distanceModel=t.distanceModel||"exponential"})))}const r=Promise.all(e).then((()=>{const e=t.clips.map((e=>e.weight||1)),n=new tn.s(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(n.directionalConeInnerAngle=2*a.w1.ToDegrees(t.innerAngle)),t.outerAngle&&(n.directionalConeOuterAngle=2*a.w1.ToDegrees(t.outerAngle)),t.volume&&(n.volume=t.volume),t._babylonData.sound=n}));t._babylonData={loaded:r}}return t._babylonData.loaded}_getEventAction(e,t,n,s,r){switch(n){case"play":return e=>{const n=(r||0)+(e-s);t.play(n)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,s,r){if(0==r.targetedAnimations.length)return Promise.resolve();const o=r.targetedAnimations[0],a=s.emitter,i=ke.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,i).then((()=>{const t=i._babylonData.sound;if(t){const n=new Qt.O(s.time,this._getEventAction(e,t,s.action,s.time,s.startOffset));o.animation.addEvent(n),r.onAnimationGroupEndObservable.add((()=>{t.stop()})),r.onAnimationGroupPauseObservable.add((()=>{t.pause()}))}}))}}Ve.RegisterExtension(nn,(e=>new sn(e)));const rn="MSFT_lod";class on{constructor(e){this.name=rn,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new o.y$,this.onMaterialLODsLoadedObservable=new o.y$,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(rn)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return Ve.LoadExtensionAsync(e,t,this.name,((e,s)=>{let r;const o=this._getLODs(e,t,this._loader.gltf.nodes,s.ids);this._loader.logOpen(`${e}`);for(let e=0;e<o.length;e++){const t=o[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new we.B);const s=e=>{n(e),e.setEnabled(!1)},a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,s).then((t=>{if(0!==e){const t=o[e-1];t._babylonTransformNode&&(this._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return t.setEnabled(!0),t}));this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?r=a:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(a))}return this._loader.logClose(),r}))}_loadMaterialAsync(e,t,n,s,r){return this._nodeIndexLOD?null:Ve.LoadExtensionAsync(e,t,this.name,((e,o)=>{let a;const i=this._getLODs(e,t,this._loader.gltf.materials,o.ids);this._loader.logOpen(`${e}`);for(let e=0;e<i.length;e++){const t=i[e];0!==e&&(this._materialIndexLOD=e);const o=this._loader._loadMaterialAsync(`/materials/${t.index}`,t,n,s,(t=>{0===e&&r(t)})).then((t=>{if(0!==e){r(t);const n=i[e-1]._data;n[s]&&(this._disposeMaterials([n[s].babylonMaterial]),delete n[s])}return t}));this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?a=o:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(o))}return this._loader.logClose(),a}))}_loadUriAsync(e,t,n){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new we.B,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((()=>this._loader.loadUriAsync(e,t,n)))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new we.B,this._materialSignalLODs[s].promise.then((()=>this._loader.loadUriAsync(e,t,n)))}return null}loadBufferAsync(e,t,n,s){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const t=(e,t)=>{const r=n,o=r+s-1;let a=e[t];return a?(a.start=Math.min(a.start,r),a.end=Math.max(a.end,o)):(a={start:r,end:o,loaded:new we.B},e[t]=a),a.loaded.promise.then((e=>new Uint8Array(e.buffer,e.byteOffset+n-a.start,s)))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then((e=>{n.loaded.resolve(e)}),(e=>{n.loaded.reject(e)})))}_getLODs(e,t,n,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=new Array;for(let t=s.length-1;t>=0;t--)if(r.push(ke.Get(`${e}/ids/${s[t]}`,n,s[t])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=new Array,n=e.material;n&&t.push(n);for(const n of e.getChildMeshes())n.material&&t.push(n.material);e.dispose();const s=t.filter((e=>this._loader.babylonScene.meshes.every((t=>t.material!=e))));this._disposeMaterials(s)}_disposeMaterials(e){const t={};for(const n of e){for(const e of n.getActiveTextures())t[e.uniqueId]=e;n.dispose()}for(const e in t)for(const n of this._loader.babylonScene.materials)n.hasTexture(t[e])&&delete t[e];for(const e in t)t[e].dispose()}}Ve.RegisterExtension(rn,(e=>new on(e)));const an="MSFT_minecraftMesh";class ln{constructor(e){this.name=an,this._loader=e,this.enabled=this._loader.isExtensionUsed(an)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtraAsync(e,t,this.name,((s,r)=>{if(r){if(!(n instanceof Ce.Y))throw new Error(`${s}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,r}return null}))}}Ve.RegisterExtension(an,(e=>new ln(e)));const cn="MSFT_sRGBFactors";class dn{constructor(e){this.name=cn,this._loader=e,this.enabled=this._loader.isExtensionUsed(cn)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return Ve.LoadExtraAsync(e,t,this.name,((s,r)=>{if(r){if(!(n instanceof Ce.Y))throw new Error(`${s}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor),r}return null}))}}Ve.RegisterExtension(cn,(e=>new dn(e)));const hn="ExtrasAsMetadata";class un{constructor(e){this.name=hn,this.enabled=!0,this._loader=e}_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{};(n.gltf=n.gltf||{}).extras=t.extras}}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,(e=>{this._assignExtras(e,t),n(e)}))}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,(e=>{this._assignExtras(e,t),n(e)}))}createMaterial(e,t,n){const s=this._loader.createMaterial(e,t,n);return this._assignExtras(s,t),s}}Ve.RegisterExtension(hn,(e=>new un(e)))}}]);
//# sourceMappingURL=319.babylonBundle.js.map